<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.paic.pluto.dao.ImageUploadDao">
	
	
	<insert id="insertUploadRecord" useGeneratedKeys="true" keyProperty="dbid" parameterType="com.paic.pluto.pojo.ImageUpload">  
		insert into pluto_img_upload(open_id,description,photo_date,create_date,type,is_delete)
		values(#{openId},#{description},#{photoDate},sysdate(),'M','N') 
	</insert>
	
	<resultMap type="com.paic.pluto.pojo.ImageUpload" id="imageUploadResultMap">
		<id column="dbid" property="dbid"/>
		<result column="open_id" property="openId"/>
		<result column="photo_date" property="photoDate"/>
		<result column="create_date" property="createDate" jdbcType="TIMESTAMP"/>
		<result column="description" property="description"/>
		
		<!-- 一对多的关系 -->
		<!-- property: 指的是集合属性的值, ofType：指的是集合中元素的类型 -->
		<collection property="imageBases" ofType="com.paic.pluto.pojo.ImageBase">
			<result column="imgDbid" property="dbid"/>
			<result column="local_id" property="localId"/>
			<result column="img_uri" property="imgUri"/>
		</collection>
	</resultMap>
	

	<select id="getMyImg" resultMap="imageUploadResultMap">
		SELECT t.dbid,t.open_id,t.photo_date,t.create_date,t.description,ib.dbid imgDbid,ib.img_uri,ib.local_id 
		FROM pluto_img_upload t,(select dbid,upload_id,case when img_uri is null then 'Y' else 'N'  end img_uri ,local_id from pluto_img_base ) ib
		where t.dbid = ib.upload_id and t.open_id = #{0} and t.type = #{1} and t.is_delete = 'N'
		order by t.create_date desc
	</select>
	
	<update id="deleteUpload">  
	 	UPDATE pluto_img_upload t 
        SET t.is_delete = 'Y'  
        WHERE t.open_id = #{0} and t.dbid = #{1} and t.is_delete = 'N';
	</update> 

</mapper>