<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.paic.pluto.dao.ImageBaseDao">
	
	<insert id="insertImgBase" useGeneratedKeys="true" keyProperty="dbid" parameterType="com.paic.pluto.pojo.ImageBase">  
		insert into pluto_img_base(upload_id,media_id,create_by,create_date,update_by,update_date,open_id,local_id)
		values(#{uploadId},#{mediaId},#{openId},sysdate(),#{openId},sysdate(),#{openId},#{localId}) 
	</insert>
	
	
	<select id="countMyImg" resultType="java.lang.Integer">
		SELECT count(1) FROM pluto_img_base t 
		where t.open_id = #{0} and t.type = #{1}
	</select>
	
	
	<select id="queryNeedDownloadMeidaId" resultType="com.paic.pluto.pojo.ImageBase">
		SELECT dbid,media_id mediaId
		FROM pluto_img_base t
		WHERE t.img_uri is null
	</select>
	
	<select id="queryNeedUploadPic" resultType="com.paic.pluto.pojo.ImageBase">
		SELECT dbid,img_uri imgUri
		FROM pluto_img_base t
		WHERE t.img_uri is not null 
		AND t.s3_img_uri is null
	</select>
	
	<update id="updateImgBaseForWeChat" parameterType="com.paic.pluto.pojo.ImageBase">  
	 	UPDATE pluto_img_base t 
        SET t.img_uri = #{imgUri} 
        WHERE t.dbid = #{dbid} ;
	</update>
	
	<update id="updateImgBaseForCeph" parameterType="com.paic.pluto.pojo.ImageBase">  
	 	UPDATE pluto_img_base t 
        SET t.s3_img_uri = #{s3ImgUri} 
        WHERE t.dbid = #{dbid} ;
	</update>
	
	<select id="queryImageInfoList" resultType="com.paic.pluto.pojo.ImageBaseAndAgree">
		select * from 
		(select b.dbid dbid,a.description description,d.countAgree countAgree,c.countMy countMy
				from pluto_img_upload a ,pluto_img_base b
				LEFT JOIN  (select img_id,count(1) countMy from  pluto_img_agree where agree_open_id=#{0} group by img_id ) c on b.dbid = c.img_id
				LEFT JOIN  (select img_id,count(1) countAgree from  pluto_img_agree  group by img_id ) d on b.dbid = d.img_id
				where a.dbid=b.upload_id
				and a.is_delete ='N' 
				and b.s3_img_uri is not null
				order by b.create_date,b.dbid desc) t
		LIMIT #{1},6
    </select>
	
	<select id="queryImageBaseByPk" resultType="com.paic.pluto.pojo.ImageBase">
		SELECT dbid,img_uri imgUri,s3_img_uri s3ImgUri FROM pluto_img_base t 
		where t.dbid =#{0}
	</select>
</mapper>