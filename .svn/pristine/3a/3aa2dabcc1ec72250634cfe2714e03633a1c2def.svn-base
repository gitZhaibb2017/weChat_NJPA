//计时器
var count;
var validTime = 120;
//加载完毕调用
$(function() {
	init();
});
// 初始化基础方法
function init() {
	initClick();
	initRegBut();
}

//初始化按钮显示文字
function initRegBut() {
	var checkForBut = sessionStorage.getItem('checkForget');
	if('true' == checkForBut){
		$('#regist').html('修改密码');
	}else{
		$('#regist').html('注册');
	}
}

// 点击事件初始化绑定
function initClick() {
	//验证码
	$('#getCode').on('click', function(e) {
		getCode();
	});
	//录入手机号和验证码
	$('#regist').on('click', function(e) {
		regist();
	});
	//返回按钮
	$('i').on('click', function(e) {
		window.history.back();
	})
}
// 注册方法
function regist() {
	/**
	 * 手机号   校验（不能为空 必须满11位）
	 * 密码  校验
	 * 	验证码 （不能为空 6位数字）
	 * 		填写的验证码和实际验证码一致
	 */
	var telephone = $('#telephone').val().trim();
	var password  = $('#password').val().trim();
	var repsword  = $('#repsword').val().trim();
	var code = $('#code').val().trim();
	if(Validator.validateNull(telephone)){
		doAlert("手机号码为空");
		return;
	}
	if(!Validator.validateRegPhone(telephone)){
		doAlert("手机号码有误");
		return;
	}
	if(Validator.validateNull(password)){
		doAlert("密码为空");
		return;
	}
	if(!Validator.validatePassword(password)){
		doAlert("输入密码格式错误,重新输入");
		return;
	}  
	if(!Validator.validateRepsword(repsword)){
		doAlert("再次输入密码格式错误");
		return;
	}  
	if(Validator.validateNull(code)){
		doAlert("验证码为空");
		return;
	}
	if(!Validator.validateCode(code)){
		doAlert("验证码格式错误");
		return;
	}
	if(password!=repsword){
		doAlert("您输入的密码不一致");
		return;
	}
    checkCode(telephone,code,password);
}
//获取验证码
function getCode() {
	var telephone = $('#telephone').val().trim();
	// 前台校验手机号码是否输入及合法性
	if ((!Validator.validateNull(telephone)) && Validator.validateRegPhone(telephone)) {
		// 通过后发送请求
		$.ajax({
			type : 'POST',
			url : "/pawj/auth/getCheckCode.do",
			data : {
				mobile : telephone
			},
			dataType : 'JSON',
			success : function(e) {
				// 根据返回码处理信息
				if ($.parseJSON(e).infoMsg == '0') {
					// 成功(需要进行页面提示),页面开始倒计时2min
					// 初始化计时器
					count = validTime;
					// 开始计时
					timeCount();
				} else if ($.parseJSON(e).infoMsg == '1') {
					// 输入为空(需要进行页面提示)
					doAlert("获取验证码失败");
				} 
			}
		});
	} else {
		// 校验不通过显示提示信息
		if (Validator.validateNull(telephone)){
			doAlert('手机号为空');
			return;
		}else if(!Validator.validateRegPhone(telephone)){
			doAlert('手机号输入有误');
			return;
		}
	}
}
// 倒计时方法
function timeCount() {
	// 计时器空判断
	if (count != null && count != undefined)
		// 计时器判断是否为0
		if (count == 0) {
			// 定时器复位,事件重新绑定
			count = validTime;
			$('#getCode').html('获取验证码');
			x=document.getElementById("getCode") // 找到元素
			x.style.background="#ffb71d";          // 改变样式
			$('#getCode').on('click', function() {
				getCode();
			});
		} else if (count > 0 && count < validTime) {
			// 0-120之间修改显示
			
			$('#getCode').html('获取验证码(' + count + ')');
			count -= 1;
			// 定时1000ms
			setTimeout('timeCount()', 1000);
			$("#getCode").css("color","rgb(42, 182, 244)");
		} else if (count == validTime) {
			// 取消绑定事件(使点击无效)
			$('#getCode').unbind();
			x=document.getElementById("getCode") // 找到元素
			x.style.background="#ccc";          // 改变样式
			$('#getCode').html('获取验证码(' + count + ')');
			$("#getCode").css("color","rgb(42, 182, 244)");
			count -= 1;
			// 定时1000ms
			setTimeout('timeCount()', 1000);
		} else {
		}
	else {
		// 错误信息输出
	}
}

// 注册
function registByPhone(telephone,password) {
	var encryptPwd = sha256_digest(password);
	$.ajax({
		type : 'POST',
		url : "/pawj/auth/register.do",
		data : {
			loginName : telephone,
			pwd:encryptPwd
		},
		dataType : "JSON",
		success : function(e) {
			if ($.parseJSON(e).infoMsg == "0") {// 成功  首页
					window.location.href = "../login/loginPAWJ.html";	
				}
			else if ($.parseJSON(e).infoMsg == "2") {
				doAlert("手机号已注册");
			}else {
				doAlert("注册失败");
			} 
		}
	});
	
}
function checkCode(telephone, code, password) {
	$.ajax({
		type : 'POST',
		url : "/pawj/auth/checkCode.do",
		data : {
			mobile : telephone,
			checkCode : code
		},
		dataType : "JSON",
		success : function(e) {
			if (count == validTime) {
				doAlert("验证码超时请重新获取");
			} else {
				if ($.parseJSON(e).infoMsg == "0") {
					registByPhone(telephone, password);
				} else {
					doAlert("验证码错误");
				}
			}
		}
	});
}

//提示消息
function doAlert(msg_temp) {
	$alertSpan = $('.login_tips').find('p');
	$alertSpan.html(msg_temp);
	$alertSpan.parent().css('display', 'block');
	setTimeout("doDispear()", 3000);
}
// 取消显示提示
function doDispear() {
	$alertSpan.parent().css('display', 'none');
	$alertSpan.html('');
}
