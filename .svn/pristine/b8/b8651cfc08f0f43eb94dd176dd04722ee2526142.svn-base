<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.paic.pawj.basic.grade.dao.GradeMapper">
	<resultMap id="grade" type="com.paic.pawj.basic.grade.dao.Grade">
		<id column="grade_id" property="gradeId"  />
		<result column="grade_name" property="gradeName"  />
		<result column="grade" property="grade"  />
	    <result column="condi_continuity" property="condiContinuity"  />
	    <result column="condi_ans_quantity" property="condiAnsQuantity" />
		<result column="condi_prev_activity" property="condiPrevActivity" />
	</resultMap>
	
	<resultMap id="currentGrade" type="java.util.HashMap">
		<result column="grade" property="grade" javaType="java.lang.Integer" />
		<result column="grade_name" property="gradeName"  javaType="java.lang.String"/>
	</resultMap>
	
	<!-- 获得当前用户的等级 -->
	<select id="getUserCurrentGrade" resultMap="currentGrade" parameterType="map">
		select 
			ifnull(t.grade,0) grade,
			ifnull(t1.grade_name,'') grade_name
		from 
			pawj_basic_user_info t
		left join 
			basic_grade_define t1
		on
			t.grade = t1.grade
		where 
			t.user_id = #{userId}
		limit 1
	</select>
	
	
	<!-- 获得当前用户的下一个等级 -->
	<select id="getUserNextGrade" resultType="java.lang.Integer" parameterType="map">
		select 
			ifnull(min(a.grade),0) grade
		from 
			basic_grade_define a
		where 
			a.grade <![CDATA[ > ]]>
			(select 
				max(ifnull(grade, 1)) 
			from 
				pawj_basic_user_info
			where 
				user_id = #{userId})
	</select>
	
	<!-- 查询当前用户下一等级的升级规则 -->
	<select id="queryUserGrade" resultMap="grade" parameterType="map">
		select 
			grade_id,
			grade_name,
			grade,
			condi_continuity,
			condi_ans_quantity,
			condi_prev_activity
		from 
			basic_grade_define 
		where
			grade = #{grade}
	</select>
	
	<!-- 查询用户连续登陆天数 -->
	<select id="getActiveDays" resultType="java.lang.Integer" parameterType="map">
		select 
			count(1) cnt
		from (	
			select 
				date_format(t.login_time, '%y-%m-%d')
			from 
				pawj_basic_user_login t 
			where 
				t.user_id = #{userId} 
			and 
				date_format(t.login_time, '%y-%m-%d') <![CDATA[ >= ]]>
				date_format(date_sub(now(), interval #{days} day), '%y-%m-%d') 
			group by
				date_format(t.login_time, '%y-%m-%d')
		) a
	</select>

	<!-- 获得用户的答题次数 -->
	<select id="getAnswerTimes" resultType="java.lang.Integer" parameterType="map">
		select 
			count(1) 
		from
			pawj_sur_answers_record t 
		where 
			t.user_id = #{userId} 
	</select>
	
	<!-- 获得用户的答题次数 -->
	<select id="getAnswerTimesDays" resultType="java.lang.Integer" parameterType="map">
		select 
			count(1) 
		from
			pawj_sur_answers_record t 
		where 
			t.user_id = #{userId} 
		and
			date_format(t.commit_time, '%y-%m-%d') <![CDATA[ >= ]]>
			date_format(date_sub(now(), interval #{days} day), '%y-%m-%d') 
	</select>
	
	<!-- 当前活跃天数-除当天以外的最近一次活跃时间，距离当天的天数不得多于N天 -->
	<select id="getPervLoingTime" resultType="java.lang.Integer" parameterType="map">
		select 
			count(1) cnt
		from
			pawj_basic_user_login t 
		where 
			t.user_id = #{userId} 
		and 
			DATE_FORMAT(t.login_time, '%Y-%m-%d')
			<![CDATA[ >= ]]>
 			DATE_FORMAT(date_sub(now(), interval #{days} day), '%Y-%m-%d') 
 		and
 			DATE_FORMAT(t.login_time, '%Y-%m-%d') 
 			<![CDATA[ <> ]]> 
 			DATE_FORMAT(now(), '%Y-%m-%d') 
	</select>
	
	<!--升级  -->
	<update id="updateUserInfoGrade" parameterType="map">
		update 
			pawj_basic_user_info t 
		set 
			t.grade = #{grade}
		where 
			t.user_id = #{userId}
	</update>
</mapper>