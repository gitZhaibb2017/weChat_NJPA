$(function() {
	/**
	 * 获取验证码-发送至手机
	 */
	$('#getMobileCode').click(function() {
		var mobile = $('#bindMobileAddress').val();
		if (Validator.validateNull(mobile)) {
			$.popAlert("请输入手机号码！");
			return false;
			
		} 
		if (Validator.validateRegPhone(mobile)) {
			// 绑定获取短信的绑定事件
			$(this).attr("disabled", true);
			wait = 120
			$(this).val(wait + "秒后重新获取");
			time = setInterval(function() {
				setTime();
			}, 1000);
			// 提交手机号,获得验证码
			$.ajax({
				type : 'POST',
				url : "/pawj/auth/getCheckCode.do",
				dataType : "JSON",
				data : {
					"mobile" : mobile
				},
				success : function(data) {
					var dat = $.parseJSON(data);
					if (dat.infoMsg == 1) {
						$.popAlert("验证码发送失败!");
					}
				}
			});
		} else {
			$.popAlert("手机号码格式不正确!");
		}
	});
	
	/**
	 * set time
	 */
	var wait;
	var time;
	function setTime() {
		wait--;
		if (wait == 0) {
			clearInterval(time);
			$('#getMobileCode').val("获取验证码");
			$('#getMobileCode').removeAttr("disabled");
		} else {
			$("#getMobileCode").val(wait + "秒后重新获取");
		}
	}

	/**
	 * 提交验证码
	 */
	$('#bindMobileSubBtn').click(function() {
		var checkCode = $('#bindMobileCode').val().trim();
		var mobile = $('#bindMobileAddress').val().trim();

		// 校验手机号码
		if (!Validator.validateRegPhone(mobile)) {
			$.popAlert("请输入11位数字的手机号码！");
			return false;
		}
		// 校验验证码
		if (!Validator.validateCode(checkCode)) {
			$.popAlert("请输入6位数字验证码！");
			return false;
		}

		$.ajax({
			type : 'POST',
			url : "/pawj/app/person/updateMobile.do",
			dataType : "JSON",
			data : {
				"mobile" : mobile,
				"checkCode" : checkCode
			},
			success : function(e) {
				var data = $.parseJSON(e);
				if (data.msg == 1) {
					$.popAlert("修改成功!");
				} else {
					$.popAlert("验证码有误！");
				}
			}
		});
	});
	
	//监听表单变化
   $("#bindMobile").changeListen({
		formId : "#bindMobile",
		onOK : function() {
			$("#bindMobileSubBtn").css({
				background : "#ffb71d"
			}).removeAttr("disabled");
		},
		onCancel : function() {
			$("#bindMobileSubBtn").css({
				background : "#ccc"
			}).attr("disabled", "disabled");
		}
	});
});

