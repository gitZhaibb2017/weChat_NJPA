var total = 0;
var current = 0;
var scrCount=0;
var flag=true;

//返回
function goBack() {
	window.history.back();
};

//获取问卷详情列表的选项
function getOptionHtml(type, option){
	switch (type){
		case 'mc'://单选
			return '<input type="radio" name="'+ option.qstId +'" value="'+option.optionCode+'" onchange="setProgress()"/>';
			break;
		case 'mcs'://多选
			return '<input type="checkbox" name="'+ option.qstId +'" value="'+option.optionCode+'" onchange="setProgress()"/>';
			break;
		case 'scr'://评分题
			return  '<fieldset>' +
					'<div id="'+option.optId+'_'+option.optionCode+'_1" class="star" onClick="starChose(\''+option.optId+'_'+option.optionCode+'\',1)"></div>'+
					'<div id="'+option.optId+'_'+option.optionCode+'_2" class="star" onClick="starChose(\''+option.optId+'_'+option.optionCode+'\',2)"></div>'+
					'<div id="'+option.optId+'_'+option.optionCode+'_3" class="star" onClick="starChose(\''+option.optId+'_'+option.optionCode+'\',3)"></div>'+
					'<div id="'+option.optId+'_'+option.optionCode+'_4" class="star" onClick="starChose(\''+option.optId+'_'+option.optionCode+'\',4)"></div>'+
					'<div id="'+option.optId+'_'+option.optionCode+'_5" class="star" onClick="starChose(\''+option.optId+'_'+option.optionCode+'\',5)"></div>'+
					'<input id="'+option.optId+'_'+option.optionCode+'" type="radio" style="display: none;">'+
				   '</fieldset>';
			break;
		case 'q'://问答题
			return '<textarea placeholder="" name="'+ option.optId +'" onchange="setProgress()" ></textarea>';
			break;
		case 'tpdanx'://图片单选   按钮 和 
			return '<input type="radio" name="'+ option.optId +'" value="'+option.optionCode+'" onchange="setProgress()"/>';
			break;
		case 'tpduox'://图片多选
			return '<input type="checkbox" name="'+ option.optId +'" value="'+option.optionCode+'" onchange="setProgress()"/>';
			break;
		default:
			break;
	}
}

//评分题选星
function starChose(id,e){
	for(var i=1;i<=5;i++){
		$('#'+id+'_'+i+'').removeClass("starOn");
		$('#'+id+'_'+i+'').addClass("star");
	}
	for(var i=1;i<=e;i++){
		$('#'+id+'_'+i+'').addClass("starOn");
	}
	$('#'+id+'').attr("checked","checked");
	$('#'+id+'').attr("value",e);
	//获取评分提选项的Id
	$('#'+id+'').attr("name", id.substring(0,id.lastIndexOf("_")));
	setProgress();
}

//答题进程
function setProgress(){
	//获取问题类型 
	 current = 0;
	$('.QAContent').each(function(index,item){
		var answerType = $(item).data("answerType");//问卷类型
		var answer = [];
		switch (answerType){
			case 'mc':
				$(this).find('input:checked').each(function(){
					var mcsValue=this.value;
					if(mcsValue == undefined || mcsValue == null){
						
					}else{//答题进程+1
						++current;
					}
				});
				break;
			case 'mcs'://多选题
				var flag=false;
				$(this).find('input:checked').each(function(){
					var mcsValue=this.value;
					if(mcsValue == undefined || mcsValue == null){
						
					}else{//答题进程+1
						flag=true;
					}
				});
				if(flag){
					++current;
				}
				break;
			case 'scr'://评分题
				var scrLen =0;
				var fieldsetlength=$(this).find('fieldset').length;
				var checkcount=0;
				$(this).find('fieldset').each(function(){
					var scrValue=$(this).find('input:checked').val();
					if (scrValue == undefined || scrValue == null ) {
						
					}else{
						checkcount=checkcount+1;
						scrLen= scrValue.length;
					}
				});
				if(fieldsetlength==checkcount){
					++current;
				}
				break;
			case 'q'://问答题
				var qVal=$(this).find('textarea').val().trim();
				if (qVal == undefined || qVal == null || qVal.length == 0) {
					
				}else{
					++current;
				}
			break;
			default:
				break;
		}
	$('#current').text(current);
	$('.QAProgress').find('label').css('width', (current/total*100).toFixed(2) + '%');
});
}
//初始化
$(function(){
	FastClick.attach(document.body);
	//下一题的按钮 获取相对应的题目
	$('.next').on('click', function(e) {
		goNext();
	});
	//获取问卷列表
	getInvestigationDetails();
	//完成答题记录
	$('.QABtn').on('click', function(){
		subMit();
	});
});
//初始化数据
function getInvestigationDetails(){
	var  investigationID= $('#investigationID').val();
	sessionStorage.setItem('investigationID',investigationID);
	$.ajax({
	type : 'POST',
	url : "/pawj/answer/queryNextQuestion.do",
	data : {
		'investigationId' : $('#investigationID').val(),
		'questMark' : "1"
	},
	dataType : "JSON",
	success: function(dat){
		if(dat != 'toQaRet'){
			window.location.href = '/pawj/wxapp/h5/answer/qaRet.jsp'
		}
		var html = '';
		var data=$.parseJSON(dat);
//		total = data.details.detail.options.length;//总的题目
//		$('#total').text(total);
		var question = data.details.detail;
		var options = '';
		question.options.forEach(function(option){//选项
			options += '<li><label>'+getOptionHtml(question.questionType,option)+ (question.questionType == 'q'?'':option.optName) +'</label></li>';
		});
		html += '<div class="QAContent" data-answer-type ="'+question.questionType+'" data-qsr-id ="'+data.details.qsrId+'" data-qst-id="'+question.qstId+'">' + 
					'<h1>'+ question.questionSeq +'.'+ question.questionName +'</h1>' +
					'<ul>'+ options +'</ul>' +
				'</div>'
			
		$('.QAContents').html(html);
	}
});
}

//获取下一道题
function goNext(){
	/**
	 * 先要判断题目的类型
	 * 然后根据不同的题目类型获取相对应的问题ID
	 * 获取相对应的选项ID
	 */
//	$.popAlert("下一题！");
	$('.QAContent').each(function(index,item){
		var qsrId = $(item).data("qsrId");//问卷ID
		var qstId= $(item).data("qstId");//问题ID
		var answerType = $(item).data("answerType");//问卷类型
		var answer = [];
		switch (answerType){
			case 'mc'://单选
				$(this).find('input:checked').each(function(){
					var mcOptId=this.name;
					var mcValue=this.value;
					if(mcValue == "" || mcValue == undefined){
						flag=false;
					}
//					alert("mc="+optId);
				});
				checkFlag(flag);
				break;
			case 'mcs'://多选题
				$(this).find('input:checked').each(function(){
					var mcsOptId=this.name;
					var mcsValue=this.value;
//					alert("mcs="+optId);
					if(mcsValue == "" || mcsValue == undefined){
						flag=false;
					}
				});
				checkFlag(flag);
				break;
			case 'scr'://评分题
				$(this).find('fieldset').each(function(){
					//获取评分的选项ID
					var scrOptId=$(this).find('input:checked')[0].name;
					var scrValue=$(this).find('input:checked').val();
					if(scrValue == "" || scrValue == undefined){
						flag=false;
					}
//					alert("scr="+scrOptId);
				});
				checkFlag(flag);
				break;
			case 'q'://问答题
				var qOptId=$(this).find('textarea')[0].name;
				var qVal=$(this).find('textarea').val().trim();
				if(qVal == "" || qVal == undefined){
					flag=false;
				}
				checkFlag(flag);
//				alert("q="+qOptId);
				break;
			default:
				break;
		}
		//请求下一题
		$.ajax({
//			url: '/pawj/app/answer/answer.do',
			type: 'post',
			dataType:'json',
			contentType:"application/json",
			data:  JSON.stringify(obj),
			success: function(dat){
				
			}
		});
	});
}

//弹出框
function checkFlag(flag){
	if(!flag){
		$.popAlert("请先答题");
	}
}
//答题完成 提交记录
function subMit(){
	var complete = 0;
	if(total == current){
		complete = 1;
	}
	if(complete == 0){
		alert("请先答题,在提交!");
		return;
	}
	var dataArr = [];
	var datalist = {};
	$('.QAContent').each(function(index,item){
		var qsrId = $(item).data("qsrId");//问卷ID
		var answerType = $(item).data("answerType");//问卷类型
		var qstId= $(item).data("qstId");//问题ID
		var answer = [];
		switch (answerType){
			case 'mc':
			case 'mcs'://单选题
				$(this).find('input:checked').each(function(){
					answer.push(this.value);
				});
				break;
			case 'scr'://评分题
				$(this).find('fieldset').each(function(){
					answer.push($(this).find('input:checked').val() || 0);
				});
				break;
			case 'q'://问答题
				answer.push($(this).find('textarea').val());
				break;
			default:
				break;
		}
		answerContent = answer.join();
		var userId = $('#userId').val();
		qsrId=$($(".QAContent")[0]).attr("data-qsr-id");
		datalist={
			"qstId":qstId,
			"qsrId":qsrId,
			"answerType":answerType,
			"answerContent":answerContent,
			"userId":userId
		};
		dataArr.push(datalist);
	});
	var obj={};
	obj.complete=complete;
	obj.data=dataArr;
	$.ajax({
		url: '/pawj/app/answer/answer.do',
		type: 'post',
		dataType:'json',
		contentType:"application/json",
		data:  JSON.stringify(obj),
		success: function(dat){
			if(dat.retCode=="0000"){
			window.location.href = "../../h5/answer/comment.html";
			}
			else{
				window.location.href = "../../h5/homePage/index.html";
			}
		}
	});

}



