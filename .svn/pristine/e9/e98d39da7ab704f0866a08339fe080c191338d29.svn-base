<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.paic.pawj.answer.dao.AnswersMapper">
	<insert id="saveAnswers" parameterType="com.paic.pawj.answer.dto.Answers">
		INSERT INTO
		pawj_sur_answers(user_id, qsr_id, qst_id, answer_type, answer_content,
		answer_time, answer_add)
		VALUES(#{userId}, #{qsrId}, #{qstId},
		#{answerType}, #{answerContent}, sysdate(),
		#{answerAdd})
		ON DUPLICATE
		KEY UPDATE
		answer_type=#{answerType},answer_content=#{answerContent},answer_time=sysdate(),answer_add=#{answerAdd}
	</insert>

	<insert id="saveAnswersDraft" parameterType="com.paic.pawj.answer.dto.Answers">
		insert into
		pawj_sur_answers_draft (user_id, qsr_id, qst_id,
		answer_type,answer_content,answer_time,answer_add) values (#{userId},
		#{qsrId}, #{qstId}, #{answerType}, #{answerContent}, sysdate(),
		#{answerAdd})
	</insert>

	<select id="queryQstnaireList" resultType="java.util.HashMap">
		select qsr_id qsrID,
		qsr_name qsrName,
		qsr_status qsrStatus,
		qsr_desc qsrDesc,
		label label,
		publish_time publishTime,
		publisher publisher
		from
		pawj_sur_questionnaire
	</select>

	<select id="getAnswerUserCount" parameterType="java.lang.String"
		resultType="int">
		SELECT count(*) FROM pawj_sur_answers where question_id =
		#{qsrId}
	</select>

	<select id="getQsrNumber" parameterType="java.lang.String"
		resultType="java.lang.Integer">
		select qsr_number from pawj_sur_questionnaire where qsr_id
		= #{qsrId}
	</select>

	<select id="getUserAnswerByQsr" parameterType="com.paic.pawj.answer.dto.Answers"
		resultType="com.paic.pawj.answer.dto.Answers">
		select
		answer_id answerId,
		investigation_id investigationId,
		question_id questionId,
		qtype qtype,
		option_id optionId,
		option_column_id optionColumnId,
		qaq_value qaqValue,
		score_value
		scoreValue,
		answer_add answerAdd,
		created_time createdTime
		from
		pawj_sur_answers
		where
		question_id = #{questionId}
		and
		investigation_id =
		#{investigationId}
	</select>

	<select id="queryAnswerRecordByUser" parameterType="com.paic.pawj.answer.dto.AnswerRecord"
		resultType="com.paic.pawj.answer.dto.AnswerRecord">
		SELECT id,investigation_Id investigationID,user_id
		userID,commit_time commitTime,answer_status answerStatus
		FROM
		pawj_sur_answers_record
		where investigation_Id=#{investigationId}
		and
		user_id = #{userId}
		and
		answer_status = '1'
		limit 1
	</select>

	<insert id="insertAnswerRecord" parameterType="com.paic.pawj.answer.dto.AnswerRecord">
		insert into
		pawj_sur_answers_record(id,
		investigation_Id,user_id,commit_time,answer_status)
		values (uuid(),
		#{investigationId},#{userId},sysdate(),#{answerStatus})
	</insert>

	<!-- 查询用户题目id是否已经存在 -->
	<select id="getAnswerRecord" parameterType="com.paic.pawj.answer.dto.AnswerRecord"
		resultType="int">
		select
		count(1) cnt
		from
		pawj_sur_answers_record t
		where
		t.investigation_id =
		#{investigationId}
		and
		t.user_id = #{userId}
	</select>

	<!-- 删除用户当前题目已经保存的答案 -->
	<delete id="deleteUserHasAnswer" parameterType="java.util.HashMap">
		delete from
		pawj_sur_answers
		where
		user_id = #{userId}
		and
		investigation_id =
		#{investigationId}
		and
		question_id = #{questionId}
	</delete>

	<!-- 保存答题选项 -->
	<insert id="insertAnswerOne" parameterType="com.paic.pawj.answer.dto.Answers">
		insert into
		pawj_sur_answers
		(
		answer_id ,
		user_id,
		investigation_id,
		question_id ,
		qtype ,
		option_id ,
		option_column_id ,
		qaq_value ,
		score_value ,
		answer_add ,
		created_time
		)
		values
		(
		replace(uuid(),'-',''),
		#{userId},
		#{investigationId},
		#{questionId},
		#{qtype},
		#{optionId},
		#{optionColumnId},
		#{qaqValue},
		#{scoreValue},
		#{answerAdd},
		now()
		)
	</insert>

	<!-- 修改答题记录状态 -->
	<update id="updaterAnswerRecordEnd" parameterType="java.util.HashMap">
		update
		pawj_sur_answers_record
		set
		answer_status = #{answerStatus}
		where
		user_id
		= #{userId}
		and
		investigation_Id = #{investigationId}
	</update>

	<select id="getQuestionIdByOption" parameterType="java.lang.String"
		resultType="java.lang.String">
		select associated_id from pawj_ivtg_question_option where
		option_id =
		#{optionId}
	</select>

	<select id="getTheLastQuestion" parameterType="java.lang.String"
		resultType="java.lang.String">
		SELECT
		question_id
		FROM
		pawj_ivtg_question
		WHERE
		investigation_id = (
		SELECT
		investigation_id
		FROM
		pawj_ivtg_question
		WHERE
		question_id = #{questionId}
		)
		AND seq > (
		SELECT
		seq
		FROM
		pawj_ivtg_question
		WHERE
		question_id = #{questionId}
		) ORDER BY seq ASC
	</select>

	<select id="getNextQuestionByParam" parameterType="java.lang.String"
		resultType="com.paic.pawj.investigation.dao.OptionQueryDTO">
		select i.investigation_id investigationID,
		i.name
		investigationName,
		q.subject questionSubject,
		q.question_type
		questionType,
		q.question_id
		questionID ,
		q.seq questionSeq,
		o.option_id
		optionID,
		o.option_code
		optionCode,
		o.option_name optionName,
		o.path path
		from
		pawj_busi_investigation
		i,pawj_ivtg_question
		q,pawj_ivtg_question_option o
		where
		i.investigation_id =
		q.investigation_id
		and q.question_id =
		o.question_id
		and q.question_id =
		#{questionId}
		ORDER BY seq asc,option_code asc
	</select>

	<select id="getInvestigation" parameterType="com.paic.pawj.answer.dto.BusinvestigationDTO"
		resultType="com.paic.pawj.answer.dto.BusinvestigationDTO">		
		 SELECT
				investigationId,
				actualEndTime,
				actualFee,
				actualStarTime,
				brief,
				coefficient,
				deductFee,
				label,
				NAME,
				planCopy,
				planEndTime,
				planStarTime,
				questionNum,
				returnCopy,
				STATUS,
				totalFee,
				userId
			FROM
				(
					SELECT
						pbi.investigation_id investigationId,
						pbi.actual_end_time actualEndTime,
						pbi.actual_fee actualFee,
						pbi.actual_start_time actualStarTime,
						pbi.answer_fee answerFee,
						pbi.brief brief,
						pbi.coefficient coefficient,
						pbi.deduct_fee deductFee,
						pbi.label,
						pbi. NAME NAME,
						pbi.plan_copy planCopy,
						pbi.plan_end_time planEndTime,
						pbi.plan_start_time planStarTime,
						pbi.question_num questionNum,
						pbi.return_copy returnCopy,
						pbi. STATUS STATUS,
						pbi.total_fee totalFee,
						pbi.user_id userId,
						IFNULL(t2.answer_status, 0) answer_status
					FROM
						pawj_busi_investigation pbi
					LEFT JOIN (
						SELECT
							investigation_id,
							answer_status,
							user_id
						FROM
							pawj_sur_answers_record
						where 
     		                user_id = #{userId}	
					) t2 ON pbi.investigation_id = t2.investigation_id
				) r
			WHERE
				r.answer_status = '0'
			LIMIT 0,5
	</select>

	<select id="getFirstQuestionOfQuestionNaire" parameterType="java.lang.String"
		resultType="com.paic.pawj.investigation.dao.OptionQueryDTO">
		select i.investigation_id investigationID,
		i.name
		investigationName,
		q.subject
		questionSubject,
		q.question_type
		questionType,
		q.question_id
		questionID ,
		q.seq questionSeq,
		o.option_id
		optionID,
		o.option_code
		optionCode,
		o.option_name optionName,
		o.path path
		from
		pawj_busi_investigation
		i,pawj_ivtg_question
		q,pawj_ivtg_question_option o
		where
		i.investigation_id =
		q.investigation_id
		and q.question_id =
		o.question_id
		and
		q.investigation_id =
		#{investigationId}
		and q.seq = '1'
		ORDER BY
		optionCode ASC
	</select>

	<select id="getFirstQuestionOfQuestionNaireMatrix"
		parameterType="java.lang.String" resultType="com.paic.pawj.investigation.dao.OptionQueryDTO">
		SELECT
		i.investigation_id
		investigationID,
		i. NAME investigationName,
		q. SUBJECT questionSubject,
		q.question_type questionType,
		q.question_id questionID,
		q.seq
		questionSeq,
		m.matrix_id matrixId,
		m.column_code matrixCode,
		m.column_name matrixName,
		M.column_desc matrixDes
		FROM
		pawj_busi_investigation i,
		pawj_ivtg_question q,
		pawj_ivtg_option_matrix m
		WHERE
		i.investigation_id = q.investigation_id
		AND q.question_id = m.question_id
		and
		q.investigation_id =
		#{investigationId}
		and q.seq = '1'
		ORDER BY
		matrixId
	</select>

	<select id="getNextQuestionMatrixByParam" parameterType="java.lang.String"
		resultType="com.paic.pawj.investigation.dao.OptionQueryDTO">
		SELECT
		i.investigation_id investigationID,
		i. NAME
		investigationName,
		q. SUBJECT questionSubject,
		q.question_type
		questionType,
		q.question_id questionID,
		q.seq questionSeq,
		m.matrix_id
		matrixId,
		m.column_code matrixCode,
		m.column_name matrixName,
		M.column_desc matrixDes
		FROM
		pawj_busi_investigation i,
		pawj_ivtg_question q,
		pawj_ivtg_option_matrix m
		WHERE
		i.investigation_id
		= q.investigation_id
		AND q.question_id = m.question_id
		AND q.question_id
		= #{questionId}
		ORDER BY matrixId
	</select>

	<!-- 保存答题question记录 -->
	<insert id="insertAnswerQuestion" parameterType="com.paic.pawj.answer.dto.AnswerQuestion">
		insert into
		pawj_sur_answer_question
		(
		id ,
		investigation_id,
		question_id ,
		answer_seq,
		user_id,
		created_time
		)
		values
		(
		replace(uuid(),'-',''),
		#{investigationId},
		#{questionId},
		#{answerSeq},
		#{userId},
		now()
		)
	</insert>

	<!-- 获得上一题map -->
	<resultMap id="prevQuestion" type="java.util.HashMap">
		<result column="question_id" property="questionId" javaType="java.lang.String" />
		<result column="answer_seq" property="answerSeq" javaType="java.lang.String" />
	</resultMap>

	<!-- 获得上一题的题目id ,answerSeq -->
	<select id="getQuestionIdByAnswerSeq" parameterType="java.util.HashMap"
		resultMap="prevQuestion">
		select
		max(question_id) question_id,
		max(answer_seq) answer_seq
		from
		pawj_sur_answer_question
		where
		answer_seq = (
		select
		max(answer_seq)
		from
		pawj_sur_answer_question
		where
		investigation_id = #{investigationId}
		and
		answer_seq <![CDATA[ < ]]>
		#{answerSeq}
		and
		user_id = #{userId}
		)
		and
		investigation_id =
		#{investigationId}
		and
		user_id = #{userId}
	</select>
	<!-- 获取问卷的答题记录 -->
	<select id="getAnswerRecordCount" parameterType="java.lang.String"
		resultType="int">
		SELECT count(*) FROM pawj_sur_answers_record where
		investigation_id =
		#{qsrId}
	</select>

	<select id="getAssociateByQuestionId" parameterType="java.lang.String"
		resultType="java.lang.String">
		select associate_option from pawj_qo_associate where
		question_id = #{questionId}
	</select>

	<!-- 获取问卷实际发布份数 -->
	<select id="getreturnCopyByqsrId" parameterType="java.lang.String"
		resultType="com.paic.pawj.answer.dto.BusinvestigationDTO">
		SELECT return_copy returnCopy FROM pawj_busi_investigation
		where investigation_id =
		#{qsrId}
	</select>

	<!-- 获得当前题目的答案 -->
	<select id="getCurrentQuestAns" parameterType="java.util.HashMap"
		resultType="com.paic.pawj.answer.dto.Answers">
		select
		answer_id answerId,
		user_id userId,
		investigation_id
		investigationId,
		question_id questionId,
		qtype qtype,
		option_id optionId,
		option_column_id optionColumnId,
		qaq_value qaqValue,
		score_value
		scoreValue,
		answer_add answerAdd,
		created_time createdTime
		from
		pawj_sur_answers t
		where
		t.user_id = #{userId}
		and
		t.investigation_id =
		#{investigationId}
		and
		t.question_id = #{questionId}
	</select>

	<select id="getQuestionTypeById" parameterType="java.lang.String"
		resultType="java.lang.String">
		SELECT
		question_type
		FROM
		pawj_ivtg_question
		WHERE
		question_id =
		#{questionId}
	</select>
	<select id="getQuestionOfQaq" parameterType="java.lang.String"
		resultType="com.paic.pawj.investigation.dao.Question">
		SELECT
		q.question_id questionId,
		q.investigation_id investigationId,
		q.subject subject,
		q.seq seq,
		q.question_type questionType
		FROM
		pawj_ivtg_question q
		WHERE
		q.question_id = #{questionId}
	</select>
	
	<select id="getTheFirstQuestionTypeAndId" parameterType="java.lang.String" resultType="com.paic.pawj.investigation.dao.Question">
	SELECT
		q.question_id questionId,
		q.investigation_id investigationId,
		q.subject subject,
		q.seq seq,
		q.question_type questionType
		FROM
		pawj_ivtg_question q
		WHERE
		q.investigation_id = #{investigationId}
    and q.seq='1'
	</select>

</mapper>