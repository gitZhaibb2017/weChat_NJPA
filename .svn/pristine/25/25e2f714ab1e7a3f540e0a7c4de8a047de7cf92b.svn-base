<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>平安科技-蓝鲸抽奖</title>
<script type="text/javascript" src="/pawj/libs/easyui/jquery.min.js"></script>
<link href="css/main.css" rel="stylesheet" media="screen and (max-width: 320px)" />  
<link href="css/main.css" rel="stylesheet" media="screen and (min-width: 321px) and (max-width: 640px)" />  
<link href="css/main.css" rel="stylesheet" media="screen and (min-width: 641px) and (max-width: 2560px)" /> 
<style type="text/css">
html,body {
	width: 100%;
	height: 100%;
	color: #666;
	font: normal 62.5% Helvetica, Arial, sans-serif, "微软雅黑";
	background-color: #dfe7eb;
	word-break: break-all;
	display: table;
}
</style>
</head>

<body class="faceBg">
<!-- <header><i onclick="back()"></i><span>现场抽奖</span></header> -->


<div class="logo"><img src="img/logo_title.png" /></div>
<div align="center" style="font-size:2.4rem; font-family:'Microsoft YaHei';margin-top: 1rem;color:#ff3;">
	<div id="prizeName"></div>
	<div id="winner"></div>
</div>
<div class="faceMain">
	<div class="facePerson">
		<img id="face" height="200" src="img/00.png" />
	</div>
	<div id="tips" style="font-size:1.8rem; font-family:'Microsoft YaHei';">
	</div>
</div>


<div class="faceBtn"><button id="stop" onclick="vote()">投票</button></div>


<script language="javascript" type="text/javascript">
var over = false;
var winner = {};
document.addEventListener("touchmove",function(e){ 
e.preventDefault();
e.stopPropagation();
},false);

function back(){
	history.back();
}

function myrefresh()
{
   window.location.reload();
}

var imgCount = 0;
var arr = new Array();
var loadedPics = new Array();

var partners = [];
var time1 = setInterval("showImg()", 50);

function init(){
	winner = {};
	$.ajax({
		async : false,
		cache : false,
		type : 'POST',
		dataType : "json",
		url : '/pawj/app/lottery/partners.do',// 请求的action路径
		error : function() {// 请求失败处理函数
			alert('请求失败');
		},
		success : function(data) {
			if(data.prize){
				partners = data.partners;
				prize = data.prize;
				$('#prizeName').text(data.prize.prizeName);
				for (i=0;i<partners.length;i++)
				{
					arr[i] = new Image();
					arr[i].onload = function(img){
						onloadCallback(img.target);
					};
				}
				
				function onloadCallback(img)
				{
					loadedPics.push(img);
				}
		
				for (i=0;i<partners.length;i++)
				{
					arr[i].src = partners[i].path;
				}
				$('#stop').text("投票");
				$('#tips').text("");
			}
			else {
				$('#stop').text("刷新");
				over = true;
				$('#tips').text("投票暂未开始，请稍候！");
			}
		}
	});
}

init();

var times = 0;
var endTime = 2;
var total = 5;
var finished = false;
function endImg(){
	if (total > 0){
		if (endTime == 0){
			times = times + 1;
			endTime = times + times*5;
			total = total - 1;
			if (loadedPics.length > 0)
			{
				if (times == 5){
					$('#face').attr("src", winner.fileName);
					$('#tips').text("投票成功");
					finished = true;
				}else{
					var ran = Math.random();
					var ram = Math.round(ran*(loadedPics.length - 1));
					
					$('#face').attr("src",loadedPics[ram].src);
					//document.images[0].src = loadedPics[ram].src;
				}
			}
		}
		endTime = endTime - 1;
	}
	else {
		clearInterval(time1);
	}
}

function showImg(){
	if (winner.fileName){
		endImg();
	}else if (loadedPics.length > 0)
	{
		var ran = Math.random();
		var ram = Math.round(ran*(loadedPics.length - 1));
		
		$('#face').attr("src",loadedPics[ram].src);
		//document.images[0].src = loadedPics[ram].src;
	}
}

/* window.requestAnimFrame = (function(){
	return window.requestAnimationFrame || 
		   window.webkitRequestAnimationFrame || 
		   window.mozRequestAnimationFrame || 
		   window.oRequestAnimationFrame || 
		   window.msRequestAnimationFrame || 
		   function( callback ){
			   window.setTimeout(callback, 1000/60);//定义每秒执行60次动画
	};
})();

(function animloop(){
	if (!finished){
		requestAnimFrame(animloop);
		showImg();	
	}
})(); */

var voteNum = 1;

var flag = false;
var slowerTimes = 0;
function slower() {
	clearInterval(time1);
	var interval = 50;
	var increment = 40;
	var totalTime = 0;
	while(times<50) {
		times++;
		interval = interval + increment;
		totalTime = totalTime + interval;				
		setTimeout(function() {
			slowerTimes++;
			if (flag) {
				return;
			}
			if (slowerTimes>3) {	
				if (over && total > 0){
					total = total - 1;		
					if (total == 0) {
						flag = true;
					} 
					if(total == 0 && winner.fileName) {
						$('#face').attr("src", winner.fileName);
						$('#tips').text("投票成功");						
						return;
					} 
					
				}
			}
			var ran = Math.random();
			var ram = Math.round(ran*(loadedPics.length - 1));		
			$('#face').attr("src",loadedPics[ram].src);
		},totalTime);
	}
}


function stop(){
	slower();
	if (voteNum > 0)
	{
		var token=window.location.hash;
		token=token.substring(1,token.length);
		$.ajax({
			async : false,
			cache : false,
			type : 'POST',
			dataType : "json",
			headers:{token: token},
			url : '/pawj/app/lottery/vote.do',// 请求的action路径
			error : function() {// 请求失败处理函数
				alert('请求失败');
			},
			success : function(data) {
				voteNum = data.voteNumber;
				if (data.retCode == "0000")
				{
					//clearInterval(time1);
					//document.images[1].src = data.fileName;
					//$('#tips').text(data.retMsg);
					$('#stop').text("刷新");
					winner = data;
					over = true;
				}
				else{
					$('#tips').text(data.retMsg);
					over = true;
					$('#stop').text("刷新");
				}
			}
		});
	}
	else {
		$('#stop').text("刷新");
		over = true;
		if (prizeName){
			$('#tips').text("您已投过此奖项！");
		}
		else{
			$('#tips').text("投票暂未开始，请稍候！");
		}
	}
	
}

function vote(){
	if (over) {
		myrefresh();
	}
	else {
		stop();
	}
}
</script>
</body>
</html>
