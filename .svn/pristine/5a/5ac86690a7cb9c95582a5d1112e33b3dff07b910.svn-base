/* 
弹出层组件
DEMO
 $('body').popup({
   title:'提示',
   formId:'form1',
   id:'pop-1'
 });
 手动关闭
 $("#pop-1").trigger("close");
 */
(function ($) {
    //队列
    var queue = [];
    //默认值配置
    var defaults = {
        id:'',
        formId:null,
        title:"提示",
        message:"",
        cnacel:"取消",
        onCancel: function(){},
        ok:"确认",
        onOk: function(){},
        cancelOnly:false,
        okClass:'button',
        noFootButton:false,
        cancelClass:'button',
        onShow:function(){},
        onHide:function(){},
        closeOnOk:true,
        hideTitle:false,
        //重写样式
        popClass:'',
        position:'',
        marginBottom:0,
        mask:true
    };
    //弹出层类
    var Popup = (function () {
        var Popup = function (containerEl, opts) {
        	this.random = this.createRadom();
            this.container = containerEl;
            if (!this.container) {
                this.container = document.body;
            }
            try {
                if (typeof (opts) === "string" || typeof (opts) === "number"){
                    opts = {
                        message: opts,
                        cancelOnly: "true",
                        cnacel: "关闭",
                        hideTitle:true
                    };
                }
                var _this = this;
                var opts = $.extend({},defaults,opts);
                if(!opts.title){
                    opts.hideTitle = true;
                }
                if(!opts.id){
                    opts.id='popup-' + Math.floor(Math.random()*1000);
                }
                for(var k in opts){
                    _this[k] = opts[k];
                }
                queue.push(this);
                //if (queue.length == 1){
                    this.show();
                //}
            } catch (e) {
                console.log("配置错误：" + e);
            }

        };

        Popup.prototype = {
        	time: function(){
        		var _this = this;
                
                this.closeTimer = setTimeout(function() {
                    _this.hide(true);
                }, _this.cleartime);
        	},
            show: function () {
                var _this = this;
                var markup = '<div id="' + this.id + '" class="car-popup hidden '+ this.popClass + '">';
                if(!_this.hideTitle){
                    markup += '<header>' + this.title + '</header>';
                }
                markup +='<div class="content-body" id="id_'+_this.random+'">' + this.message + '</div>'+
                         '<footer style="clear:both;">'+
                             '<a href="javascript:;" class="car-popup-cancel ' + this.cancelClass + '">' + this.cnacel + '</a>'+
                             '<a href="javascript:;" class="car-popup-ok ' + this.okClass + '"  >' + this.ok + '</a>'+
                        ' </footer>'+
                     '</div></div>';
                $(this.container).append($(markup));
                //添加外部表单
                if(this.formId){
                    var $content =  $(this.container).find('#id_'+_this.random);
                    var $form = $('#'+this.formId);
                    this.$formParent = $form.parent();
                    $form.appendTo($content);
                }

                var $wrap = $("#" + this.id);
                $wrap.bind("close", function () {
                    _this.hide();
                });

                if (this.cancelOnly) {
                    $wrap.find('.car-popup-ok').hide();
                    $wrap.find('.car-popup-cancel').addClass('center');
                }
                
                if (this.noFootButton) {
                    $wrap.find('.car-popup-ok').hide();
                    $wrap.find('.car-popup-cancel').hide();
                }
                
                $wrap.find('A').each(function () {
                    var button = $(this);
                    button.bind('click', function (e) {
                        if (button.hasClass('car-popup-cancel')) {
                            _this.onCancel.call(_this.onCancel, _this);
                            _this.hide();
                        } else if(button.hasClass('car-popup-ok')){
                            _this.onOk.call(_this.onOk, _this);
                            if (_this.closeOnOk)
                                _this.hide();
                        }
                        e.preventDefault();
                    });
                });
                _this.positionPopup();
                //遮罩标识
                if(_this.mask){
                	Mask.show(0.5);
                	Mask.setPopup(_this);
                }
                $wrap.bind("orientationchange", function () {
                    _this.positionPopup();
                });

                //force header/footer showing to fix CSS style bugs
                $wrap.find("header").show();
                $wrap.find("footer").show();
                setTimeout(function(){
                    $wrap.removeClass('hidden');
                    $('#'+_this.formId).removeClass('formhidden');
                    _this.onShow(_this);
                    //跑定时器
                    if (!isNaN(_this.cleartime)&&_this.cleartime!=null) {
                        _this.time();
                    }
                },50);
            },

            hide: function (nohiddenMask) {
                var _this = this;
                $('#' + _this.id).addClass('hidden');
                $('#' + _this.formId).addClass('formhidden');
                if(!nohiddenMask){
                	Mask.hide();
                }
                if($.os && !$.os.ie&&!$.os.android){
                    setTimeout(function () {
                        _this.remove();
                    }, 250);
                } else{
                    _this.remove();
                }
            },

            remove: function () {
                var _this = this;
                if(_this.onHide){
                    _this.onHide.call();
                }
                var $wrap = $("#" + _this.id);
                if(_this.formId){
                    var $form = $('#'+_this.formId);
                    $form.appendTo(_this.$formParent);
                }

                $wrap.unbind("close");
                $wrap.find('.car-popup-ok').unbind('click');
                $wrap.find('.car-popup-cancel').unbind('click');
                $wrap.unbind("orientationchange").remove();
                for(var i = 0;i<queue.length;i++){
                	if(queue[i].random == _this.random){
                		queue.splice(i, 1);
                	}
                }
//                if (queue.length > 0)
//                    queue[0].show();
            },
            positionPopup: function () {
                var _this = this;
                if(_this.position==='center'){
                	_this.positionCenter();
                }else{
                	_this.positionBottom(_this.marginBottom);
                }
            },
            //上下居中
            positionCenter: function () {
                var $wrap = $('#' + this.id);
                var w0 = $(window).width()||360
                    ,h0 = $(window).height()||500
                    ,w1 = $wrap[0].clientWidth||300
                    ,h1 = $wrap[0].clientHeight||100;

                /*$wrap.css("top", ((h0 / 2.5) + window.pageYOffset) - (h1 / 2) + "px")
                     .css("left", (w0 / 2) - (w1 / 2) + "px");*/
                $wrap.css("top", ((h0 / 2.5) + window.pageYOffset) - (h1 / 2) + "px");
            },
            //底部距离
            positionBottom: function (magrinBottom) {
                var $wrap = $('#' + this.id);
                var w0 = $(window).width()||360
                ,w1 = $wrap[0].clientWidth||300;
                $wrap.css("bottom", magrinBottom+ "px");
                $wrap.css("left", (w0 / 2) - (w1 / 2) + "px");
            },
            createRadom: function(){
            	var Num = "";
            	for(var i=0;i<3;i++){
            		Num += Math.floor(Math.random()*10);
            	}
            	return Num;
            }
        };
        return Popup;
    })();
    //遮罩类-单例
    var Mask = {
    	setPopup:function(popup){
    		this.popup = popup;
    	}, 	
        isShow : false
        ,show:function(opacity){
        	var self = this;
            if (this.isShow){
                return;
            }
            opacity = opacity ? " style='opacity:" + opacity + ";'" : "";
            $('body').prepend($("<div id='car-pop-mask'" + opacity + "></div>"));
            $('#car-pop-mask').bind("touchstart", function (e) {
                //e.preventDefault();
            	self.popup.hide();
            	e.preventDefault();
            	
            }).bind("touchmove", function (e) {
                e.preventDefault();
            });
            this.isShow = true;
        }
        ,hide:function(){
            this.isShow = false;
            $('#car-pop-mask').unbind("touchstart")
                .unbind("touchmove")
                .remove();
        }
    };
    
    //继承
//    function inheritPrototype(subType,superType){
//		var prototype = Object.create(superType.prototype);
//		prototype.constructor = subType;
//		subType.prototype = prototype;
//	}

    //注册到对象
    $.fn.popup = $.popup = function (opts) {
        return new Popup(this[0], opts);
    };
    //alert提示框
    $.popAlert = function (opts) {
        return new Popup(this[0], {
            noFootButton: true,
            message: opts,
            hideTitle: true,
            marginBottom:20,
            popClass:'alertPop',
            cleartime:2000,
            mask:false
		});
    };
    
//    $.fn.popupshare = function(opts){
//    	function PopupShare(opts){
//    		Popup.apply(this,arguments);
//    	};
//    	inheritPrototype(PopupShare,Popup);
//    	PopupShare.prototype.positionPopup = function(){};  	
//    	return new PopupShare(this[0], opts);
//    }
})(Zepto);