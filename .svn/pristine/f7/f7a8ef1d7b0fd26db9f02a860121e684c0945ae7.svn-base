/**
 * 
 */
(function() {})();
	'use strict';
	 var qstNum = 0;
	var qstSeqJSON = [];
    $('#qst_type_select').combobox({
    	url:'qstTypes.json',
    	valueField:'id',
    	textField:'text',
    	onSelect: function(record){
    		if (record.id == 'qst_typ_sel'){
		    	$('#qst1_opt1').prop("hidden", false);
    		} else if (record.id == 'qst_typ_src'){
		    	$('#qst_asw_src').prop("hidden", false);
    		}
    	}
    });
    
	function findOptNum(qstId){
		var optNum = 1;
		$('#'+qstId).find("tr").each(function (i, e){
			if (e.id && e.id.indexOf(qstId + '_opt') != -1){
				optNum = optNum + 1;
			}
		});
		return optNum;
	}
	
    function addOption(qstId){
    	var optNum = findOptNum(qstId);
    	var optHtml = '<tr id="'+qstId+'_opt'+optNum+'" >'+
					  '<td>选项'+optNum+':</td> '+
					  '<td><input class="easyui-textbox" style="width:600px;" type="text" name="name" data-options="required:true"></input></td>'+
					  '<td><a href="javascript:void(0)" class="easyui-linkbutton" onclick="delOption('+qstId+'_opt'+optNum+')">DEL</a></td>'+
					  '</tr>';
		$('#'+qstId).find("table").find("#"+qstId+"_add").before(optHtml);
    	$.parser.parse('#'+qstId+'_opt'+optNum);
    }
    
    function addQuestion(){
    	qstNum = qstNum + 1;
    	qstSeqJSON.push({id: qstNum, text: qstNum});
    	var qstHtml = '<div id="qst'+qstNum+'"><div class="easyui-panel" title="新问题'+qstNum+'" style="width:100%" data-options="tools:\'#tt'+qstNum+'\'">'+
						'<table cellpadding="5">'+
						'<tr>'+
						'<td>问题序号</td>'+
						'<td><select id="qst_seq_select_'+qstNum+'" class="easyui-combobox" style="width:600px;" data-options="valueField:\'id\', textField:\'text\'"></td>'+
					    '</tr>'+
			    		'<tr>'+
			    		'	<td>问题题目:</td>'+
			    		'	<td><input id="qst_name_'+qstNum+'" class="easyui-textbox" style="width:600px;" type="text" name="name" data-options="required:true"></input></td>'+
			    		'</tr>'+
			    		'<tr>'+
			    		'	<td>问题类型</td>'+
			    		'	<td><select id="qst_type_select_'+qstNum+'" class="easyui-combobox" style="width:600px;" name="language" ></select></td>'+
			    		'</tr>'+
			    		'<tr id="qst_asw_sel" hidden="false">'+
			    		'	<td>问题说明</td> '+
			    		'	<td><input class="easyui-textbox" style="width:600px;height:60px;" name="message" data-options="multiline:true" ></input></td>'+
			    		'</tr>'+
				    	'</table>'+
						'<div id="tt'+qstNum+'">'+
						'	<a href="javascript:void(0)" class="icon-remove" onclick="delQuestion(qst'+qstNum+')"></a>'+
						'</div>'+
					   '</div></div>';
    	$('#qsrPanel').append(qstHtml);
    	$.parser.parse('#qst'+qstNum);
    	
    	function clearQst(qstType, qstId){
    		$('#' + qstId).find("tr").each(function(i, e){
    			if (e.id){
    				$('#'+e.id).remove();
    			}
    		});
    	}
    	
    	function addTrByQstType(qstType, qstId){
    		if (qstType == 'qst_typ_mc' || qstType == 'qst_typ_mcs'){
    			var optNum = findOptNum(qstId);
    			var trId = qstId+'_opt'+optNum;
    	    	var optHtml = '<tr id="'+trId+'" >'+
				  '<td>选项'+optNum+':</td> '+
				  '<td><input class="easyui-textbox" style="width:600px;" type="text" name="name" data-options="required:true"></input></td>'+
				  '<td><a href="javascript:void(0)" class="easyui-linkbutton" onclick="delOption('+qstId+'_opt'+optNum+')">DEL</a></td>'+
				  '</tr>';
    			$('#'+qstId).find("table").append(optHtml);
    			
    			if (optNum == 1){
    				$('#'+qstId).find("table").append('<tr id="'+qstId+'_add"><td><a href="javascript:void(0)" class="easyui-linkbutton" onclick="addOption(\''+qstId+'\')">ADD</a></td></tr>');
    			}
    			
    			$.parser.parse('#' + trId);
    			$.parser.parse('#' +qstId+'_add');
    		} else if (qstType == 'qst_typ_scr'){
    			
    		}
    	}
	    $('#qst_type_select_'+qstNum).combobox({
	    	url:'qstTypes.json',
	    	valueField:'id',
	    	textField:'text',
	    	onChange: function(record){
	    		var selectID = $(this).attr("id");
	    		var num = selectID.substr(selectID.lastIndexOf('_')+1);
	    		var qstID = 'qst' + num;
	    		clearQst(record, qstID);
	    		addTrByQstType(record, qstID);
	    	}
	    });
	    $("select[id^='qst_seq_select_']").combobox("loadData", qstSeqJSON);
	    $('#qst_seq_select_'+qstNum).combobox('setValue', qstNum);
    }
    
    function delOption(eleID){
    	$(eleID).remove();
    }
    
    function delQuestion(eleID){
    	$(eleID).parent().remove();
    }
    
    function getBaseInfo(){
    	var baseInfo = {};
    	baseInfo.name = $('#qsrName').val();
    	baseInfo.brief=$('#qsrDesc').val();
    	
    	return baseInfo;
    }
    
	function saveQestionnaire(){
		var questionnaire = getBaseInfo();
		var questions = [];
		$('#qsrPanel').find('div[id^=qst]').each(function(i, question){
			var qst = {};
			qst.qstSeq = $(this).find('select[id^=qst_seq_select_]').val();
			qst.qstName = $(this).find('input[id^=qst_name_]').val();
			qst.qstType = $(this).find('select[id^=qst_type_select_]').val();
			questions.push(qst);
		});
		questionnaire.questions = questions;
		alert(JSON.stringify(questionnaire));
		
		$.ajax({
			async : false,
			cache : false,
			type : 'POST',
			dataType : "json",
			data : {investigation: JSON.stringify(questionnaire)},
			url : '/pawj/investigation/saveInvestigation.do',// 请求的action路径
			error : function() {// 请求失败处理函数
				alert('请求失败');
			},
			success : function(data) {
				alert(data);
			}
		});
	}
	function clearForm(){
		$('#ff').form('clear');
	}