/**
 * 页面初始化-加载数据   
 */ 
$(function() {
	//实名认证
	$('#certification').on('click', function(e) {
		certification();
	});
	//初始化数据
	getPersonInfo();
	/**
	 * 弹出窗-编辑用户信息
	 */
	$('.lineInfo2').find("li").on('click', function(e) {
		// 获得当前修改的id
		var paramId = $(this).find("span:last-child").attr("id");
		// 获得当前修改的字段名称
		var titleName = $(this).find("span:first-child").text();
		// 获得要修改的值
		var oldValue = $(this).find("span:last-child").text();
		// form1
		editInfo(paramId, titleName, oldValue);
});
	/**
	 * 弹出窗-密码修改
	 */
	$('.lineInfo').find(".pw").on('click', function(e) {
		editPwd(e);
	});
});
//实名认证
function certification(){
	$.popAlert("精彩尽在二期");
}

//获取个人信息
function getPersonInfo(){
	 /**
	 * 获取个人信息 
	 */ 
	$.ajax({
		type : 'POST',
		url :"/pawj/app/person/queryUserInfo.do",
		dataType : "JSON",
		success : function(dat) {
			var data = $.parseJSON(dat);
			var userName = data.name;//姓名
			var nickName= data.nickName;//昵称
			var sex = data.sex;//性别
			var profession = data.profession;//职业
			var mobile = data.mobile;//手机
			sessionStorage.setItem('mobile',mobile);
			var email = data.email;//邮箱
			var picturePath = data.picturePath;// 头像路径
			if (!Validator.validateNull(picturePath)){
				$(".photo").attr("src", picturePath);
			}
			
			// 页面赋值
			if (!Validator.validateNull(userName)) {
				 $("#name").text(userName);
			}
			if (!Validator.validateNull(nickName)) {
				$("#nickName").text(nickName);
			}
			if (!Validator.validateNull(sex)) {
			 	$("#sex").text(sex);
			}
			if (!Validator.validateNull(profession)){
				$("#profession").text(profession);
			}
			if(!Validator.validateNull(mobile)){
					bindPhone(mobile);	
			}else{
				var createPhone = '<a  id="blindPhone">绑定</a>'
			    var em = $("#blind").html(createPhone);
			}
			if(!Validator.validateNull(email)){
					bindEmail(email);
			}else{
			   var createEmail = '<a href="bindemail.html">绑定</a>'
			   var em = $("#blind2").html(createEmail);
			}
		}
	});
 }




//弹出窗-编辑用户信息
function editInfo(paramId, titleName, oldValue) {
	var createHtml;
	if(paramId == "sex"){
		createHtml = '<div class="sexDiv"><input type="radio" name="sex" checked="checked" value="男" ><b>男</b><br/>'
				   + '<input type="radio" name="sex" value="女" ><b>女</b></div>';
	}else {
		createHtml = '<input type="text" value="' + oldValue + '">'; 
	}
	var formHtml = $('#form-1');
	formHtml.html(createHtml);
	// 弹出窗
    $('body').popup({
        title: '修改' + titleName,
        id: 'pop-1',
        formId: 'form-1',
        closeOnOk: false,
        onCancel: function() {
        	formHtml.html('');
        },
        ok: '确认',
        position:'center',
        onOk: function(){
       // 表单提交
         formSumbit(paramId);
        }
    });
    // 
    if (paramId == "sex") {
    	var radioSex = $("#form-1 input[type='radio']");
    	$.each(radioSex, function(i, item){
    		if (oldValue == item.value) {
    			item.checked = true;
    			return false;
    		}
    	});
    }
    return false;

}

//编辑密码
function editPwd(e){
	var createHtml;
	createPwHtml = '<ul class="fmpw"><li><span>原密码:</span><span><input type="password" id="oldPwd"  /></span></li><li id="op"></li>'+
               '<li><span>新密码:</span><span><input type="password" id="newPwd" onfocus="formSumbit2()"/></span></li>'+
               '<li><span id="spwd">确认密码:</span><span><input type="password"  id="SurePwd"></span><span id="pwd"></span></li><li id="sp"></li></ul>'
    var SurePwd = $("#form-1").html(createPwHtml);
	// 弹出窗
	$('body').popup({
		title : '修改密码',
		id : 'pop-1',
		formId : 'form-1',
		closeOnOk :false,
		onCancel : function() {
			SurePwd.html(''); 
		},
		ok : '确认',
		position:'center',
		onOk : function() {
			var oldPwd  =  $("#form-1").find("#oldPwd").val();
			var newPwd  = $("#form-1").find("#newPwd").val();
		    var SurePwd = $("#form-1").find("#SurePwd").val();
		    if(oldPwd.length != 0 && newPwd.length != 0 && SurePwd.length != 0 ){
		    	SurePwdSubmit();
		    }
		}
	});
	//获得焦点
	$("#form-1").find("#oldPwd").focus();
	return false;
}
/**
 * 原密码校验
 */
function formSumbit2() {
	$("#op").html('');
	// 获得参数
	var oldObj = $("#form-1").find("#oldPwd");
	var oldPwd = oldObj.val();
	if(Validator.validateNull(oldPwd)){
		// 弹出窗
		$.popAlert("请输入原密码！");
		oldObj.focus();
		return false;
	}
	// 提交保存
	$.ajax({
		type : 'POST',
		url : "/pawj/app/person/checkOldPwd.do",
		dataType : "JSON",
		data : {
			"oldPwd" : oldPwd
		},
		success : function(data) {
			var e = $.parseJSON(data);
			if(e.msg == 0){
				$("#op").html('<span></span><span><span color="red">密码有误！</span></span>');
				oldObj.val("").focus();
			}
		}
	});
}
 /**
 * 修改密码
 */
 function SurePwdSubmit(){
	var oldPwd  =  $("#form-1").find("#oldPwd").val();
	var newPwd  = $("#form-1").find("#newPwd").val();
    var SurePwd = $("#form-1").find("#SurePwd").val();
    if(newPwd != SurePwd){
		$("#sp").html('<span></span><span ><font color="red">两次密码输入不一致，请重新输入！</font></span>');
		return;
	}
	$.ajax({
		type : 'POST',
		url : "/pawj/app/person/updatePwd.do",
		dataType : "JSON",
		data : {
			"pwd"  : newPwd
		},
		success : function(data) {
			var e = $.parseJSON(data);
			// 根据后台返回值判断是否保存成功
			if (e.msg == 1 && newPwd == SurePwd) {
				// 弹出窗
				$.popAlert("修改成功");
			}
			// 成功后隐藏下方出现的值
			$('#form-1').html('');
			// 成功后关闭窗口
			$("#pop-1").trigger("close");
		}

	});

}

 /**
 * 修改表单提交
 */
 function formSumbit(paramId) {
	var paramValue = $('#form-1').find('input').val();
	if(paramId == "sex"){ 
		paramValue = $("input[type='radio']:checked").val();
	}
    $.ajax({
		type : 'POST',
		url :"/pawj/app/person/updateUserInfoByKey.do",
		dataType : "JSON",
		data: {
			"paramKey" : paramId, 
			"paramValue" : paramValue
		},
		success : function(result) {
			// 提交成功后，修改页面值
		    $("#" + paramId).text(paramValue);
		    //成功后隐藏下方出现的值
		    $('#form-1').html('');
		    // 成功后关闭窗口
		    $("#pop-1").trigger("close");
		}
   });
}

/**
 * 手机显示
 * @param mobile
 */
 function bindPhone(mobile){
	var hidetel =CommonTool.starStr(mobile,0,4);
	sessionStorage.setItem('hidetel',hidetel);
	var bind = '<a href="unbindMobile.html">解绑</a>';
	var mobile = $("#mobile").text(hidetel); 
	var showMb = $("#blind").html(bind);
	
}

 /**
 * 邮箱显示
 * @param email
 * @returns
 */
 function bindEmail(email){
	var emailLength = email.length;
	var emNum = email.indexOf("@");
	var emOne= email.substr(0,1);
	var emailArr = email.split("@");
	var hidemail =CommonTool.starStr(emailArr[0],2,1)+"@"+emailArr[1];
	var bind = '<a href="unbindemail.html">解绑</a>';
    var email = $("#email").text(hidemail);
    var showEm= $("#blind2").html(bind);
    
}
/**
 * 退出登录
 */
function loginOut(){
	$.ajax({
		type : 'POST',
		url :"/pawj/app/person/logOut.do",
		dataType : "JSON",
		success : function(result) {
			window.location.href = "../../h5/login/loginPAWJ.html";
		}
   });
}

/**
* 更换头像
*/
function uploadPic(){
//	var newPath = document.getElementById("uploadFile").value;
//	$('.photo').attr('src', newPath);
	var formData = new FormData($( "#uploadForm" )[0]);
	$.ajax({
		type : 'POST',
		url :'/pawj/app/person/uploadPicH5.do',
		dataType : 'JSON',
		data:formData,
		async: false,  
       cache: false,  
       contentType: false,  
       processData: false,
		success : function(e){
			var data = $.parseJSON(e);
			if(!Validator.validateNull(data.filePath)){
				getPersonInfo();
			}else{
				$.popAlert("头像上传失败!");
			}
		}
	});
}

function onError(){
	$(".photo").attr("src","../../images/icon_avatar.png");
}

	  