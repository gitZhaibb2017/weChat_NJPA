var total = 0;
var current = 0;
var scrCount=0;
var flag;
var questMark =1;//
var html = '';
var multilateOption =[];
var questionType;//问卷类型
//获取URL请求参数
function GetQueryString(name)
{
	var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
	var r = window.location.search.substr(1).match(reg);
	if(r!=null)return unescape(r[2]); return null;
}

//返回 
function goQaBack(){
	$('body').popup({
		title : '确定放弃本次问卷答题吗',
		id : 'pop-1',
		formId : 'form-1',
		closeOnOk :false,
		onCancel : function() {
			$("#pop-1").trigger("close");
		},
		ok : '确认',
		position:'center',
		onOk : function() {
			window.location.href="../../h5/answer/conference.html";
		}
	});
}

//初始化
$(function(){
	FastClick.attach(document.body);
	//下一题的按钮 获取相对应的题目
	$('.next').on('click', function(e) {
		goNext();
	});
	//获取上一题对应的题目
	$('.before').on('click', function(e) {
		goPrev();
	});
	//获取get请求 重点参数
	var investigationID = GetQueryString("investigationID");
	//获取问卷详情列表
	getInvestigationDetails(investigationID);
	//完成答题记录
	$('.QABtn').on('click', function(){
		subMit();
	});
});
//返回
function goBack() {
	window.history.back();
};
//是否显示名称 
function showName(type){
	var flag = false;
	if(type == 'qaq' || type == 'pmc' || type == 'pmcs'){
		flag = true;
	}
	return flag;
}
//显示上一题的操作
function showNext(){
	$('#goBefore').show();
	$('#goNext').removeClass("onlyButton");
	$('#goNext').addClass("next");
}
//不显示上一题的标志
function showBefore(){
	$('#goBefore').hide();
	$('#goNext').removeClass("next");
	$('#goNext').addClass("onlyButton");
}
//上一题下一题都不显示
function hideAll(){
	$('#goBefore').hide();
	$('#goNext').hide();
}
//第一次进来首页 有返回  后面无返回
function notShowNum(){
	$("header i").show();
}
//初始化 显示下一题
function hideGoBefore(){
	$('#goBefore').hide();
	$('#goNext').removeClass("next");
	$('#goNext').addClass("onlyButton");
}
//获取问卷详情列表的选项
function getOptionHtml(type, option,answer){
	switch (type){
		case 'mc'://单选 
			var html = '<input type="radio" id="'+option.optId+'" name="'+ option.qstId +'" value="'+option.optionCode+'"  />';
			if(answer && answer.length > 0){
				if(answer[0].questionId == option.qstId && answer[0].optionId == option.optId){
					html = '<input type="radio" id="'+option.optId+'" name="'+ option.qstId +'" value="'+option.optionCode+'"  checked/>'
				}
			}
			return html;
			break;
		case 'mcs'://多选
			var html = '<input type="checkbox" id="'+option.optId+'" name="'+ option.qstId +'" value="'+option.optionCode+'"  />';
			if(answer && answer.length > 0){
				for(var i=0;i<answer.length;i++){
					if(answer[i].questionId == option.qstId && answer[i].optionId == option.optId){
						html = '<input type="checkbox" id="'+option.optId+'" name="'+ option.qstId +'" value="'+option.optionCode+'"  checked/>';
					}
				}
			}
			return html;
			break;
		case 'scr'://评分题
			return  '<fieldset>' +
					'<div id="'+option.optId+'_1" class="star" onClick="starChose(\''+option.optId+'\',1)"></div>'+
					'<div id="'+option.optId+'_2" class="star" onClick="starChose(\''+option.optId+'\',2)"></div>'+
					'<div id="'+option.optId+'_3" class="star" onClick="starChose(\''+option.optId+'\',3)"></div>'+
					'<div id="'+option.optId+'_4" class="star" onClick="starChose(\''+option.optId+'\',4)"></div>'+
					'<div id="'+option.optId+'_5" class="star" onClick="starChose(\''+option.optId+'\',5)"></div>'+
					'<input id="'+option.optId+'" value="" type="radio" style="display: none;">'+
				   '</fieldset>';
			break;
		case 'qaq'://问答题
			var html='<textarea placeholder=""></textarea>';
			if (answer) {
				html='<textarea placeholder="" checked>'+answer[0].qaqValue+'</textarea>';
			}
			return html ;
			break;
		case 'pmc'://图片单选
			var html = '<input type="radio" id="'+option.optId+'" name="'+ option.qstId +'" value="'+option.optionCode+'"   style="float: left;"/><img style="width: 100px;margin-left: 30px;"src="'+option.path+'">';;
			if(answer && answer.length > 0){
				if(answer[0].questionId == option.qstId && answer[0].optionId == option.optId){
					html = '<input checked type="radio" id="'+option.optId+'" name="'+ option.qstId +'" value="'+option.optionCode+'"   style="float: left;"/><img style="width: 100px;margin-left: 30px;"src="'+option.path+'">';
				}
			}
			return html;
			break;
		case 'pmcs'://图片多选
			var html = '<input type="checkbox" id="'+option.optId+'" name="'+ option.optId +'" value="'+option.optionCode+'"   style="float: left;" /><img style="width: 100px;margin-left: 30px;" src="'+option.path+'">';
			if(answer && answer.length > 0){
				for(var i=0;i<answer.length;i++){
					if(answer[i].questionId == option.qstId && answer[i].optionId == option.optId){
						html = '<input checked type="checkbox" id="'+option.optId+'" name="'+ option.optId +'" value="'+option.optionCode+'"   style="float: left;" /><img style="width: 100px;margin-left: 30px;" src="'+option.path+'">';
					}
				}
			}
			return html;
			break;
		case 'mmc'://矩阵单选
			var options = option.detail.options;//纵列
			var matrixs = option.matrix.matrixs;//横列
			var td = '<td class="jzTd"></td>';
			var tr = '';
			var anFlag = false;
			matrixs.forEach(function(matrix){
				td += '<td class="jzTd">'+matrix.matrixName+'</td>';
			});
			tr = '<tr class="jzTr">'+td+'</tr>';//添加第一行
			options.forEach(function(opt){
				td = '';
				td = '<td class="jzTd">'+opt.optName+'</td>';
				matrixs.forEach(function(matrix){
					var html='<td id="'+matrix.matrixId+'" class="jzTd"><input type="radio" id="'+matrix.matrixId+'" name="'+opt.optId+'"></td>';
					var checkHtml = '<td id="'+matrix.matrixId+'" class="jzTd"><input type="radio" id="'+matrix.matrixId+'" name="'+opt.optId+'" checked ></td>';
					if(answer){
						for(var i=0;i<answer.length;i++){
							if(answer[i].optionColumnId == matrix.matrixId && answer[i].optionId == opt.optId){
								anFlag = true;
								break;
							}else{
								anFlag=false;
							}
						}
					}
					if(anFlag){
						td +=checkHtml ;
					}
					else{
						td +=html ;
					}
				});
				tr += '<tr class="jzTr">'+td+'</tr>';
			});
			return '<table class="jzTabel">'+tr+'</table>';
			break;
		case 'mmcs'://矩阵多选
			var options = option.detail.options;//纵列
			var matrixs = option.matrix.matrixs;//横列
			var td = '<td class="jzTd"></td>';
			var tr = '';
			var anFlag = false;
			matrixs.forEach(function(matrix){
				td += '<td class="jzTd">'+matrix.matrixName+'</td>';
			});
			tr = '<tr class="jzTr">'+td+'</tr>';//添加第一行
			options.forEach(function(opt){
				td = '';
				td = '<td class="jzTd">'+opt.optName+'</td>';
				matrixs.forEach(function(matrix){
					var html= '<td id="'+matrix.matrixId+'" class="jzTd"><input type="checkbox" id="'+matrix.matrixId+'" name="'+opt.optId+'"></td>';
					var checkedHtml='<td id="'+matrix.matrixId+'" class="jzTd"><input type="checkbox" id="'+matrix.matrixId+'" name="'+opt.optId+'" checked></td>';
					if (answer) {
						for(var i=0;i<answer.length;i++){
							if(answer[i].optionColumnId == matrix.matrixId && answer[i].optionId == opt.optId){
								anFlag =  true;
								break;
							}else{
								anFlag = false;
							}
						}
					}
					if (anFlag) {
						td += checkedHtml;
					}
					else{
						td += html;
					}
				});
				tr += '<tr class="jzTr">'+td+'</tr>';
			});
			return '<table class="jzTabel">'+tr+'</table>';
			break;
		default:
			break;
	}
}

//评分题选星
function starChose(id,e){
	for(var i=1;i<=5;i++){
		$('#'+id+'_'+i+'').removeClass("starOn");
		$('#'+id+'_'+i+'').addClass("star");
	}
	for(var i=1;i<=e;i++){
		$('#'+id+'_'+i+'').addClass("starOn");
	}
	$('#'+id+'').attr("checked","checked");
	$('#'+id+'').attr("value",e);
}

//初始化数据
function getInvestigationDetails(investigationID){
	sessionStorage.setItem('investigationID',investigationID);
	$.ajax({
	type : 'POST',
	url : "/pawj/answer/queryNextQuestion.do",
	data : {
		'investigationId' : investigationID,
		'questMark' : questMark
	},
	dataType : "JSON",
	success: function(dat){
		if(dat.infoMsg == "9999"){
			$.popAlert("查询问卷信息失败");
		}else{
			if(dat == 'toQaRet'){
				$.popAlert("该问卷已作答,请选择其他题目!");
				hideAll();
//				$('body').html("该问卷已作答,请选择其他题目!");
			}else{
				var data=$.parseJSON(dat);
				var question = data.details.detail;
				questionType= question.questionType;
				var details = data.details;
				questMark = data.details.questMark;
				if(!Validator.validateNull(questMark)){
					hideGoBefore();
				}
				var options = '';
				if(questionType == 'mmc' || questionType == 'mmcs'){//矩阵分支
					options = '<li><label>'+getOptionHtml(question.questionType,details)+'</label></li>';
				}else{//非矩阵分支
					question.options.forEach(function(option){//选项
						options += '<li><label>'+getOptionHtml(question.questionType,option)+ (showName(question.questionType)?'':option.optName) +'</label></li>';
					});
				}
				html += '<div class="QAContent" data-answer-type ="'+question.questionType+'" data-answer-seq ="'+question.questionSeq+'" data-qsr-id ="'+data.details.detail.qsrId+'" data-qst-id="'+question.qstId+'">' + 
				'<h1>'+ question.questionSeq +'.'+ question.questionName +'</h1>' +
				'<ul>'+ options +'</ul>' +
				'</div>'
				
				$('.QAContents').html(html);
			}
		}
		
	}
});
}
//获取上一题目
function goPrev(){
	$('.QAContent').each(function(index,item){
		var investigationId = $(item).data("qsrId");//问卷ID
		var questionId= $(item).data("qstId");//问题ID
		var answerSeq = $(item).data("answerSeq");//题号
		$.ajax({
			url: '/pawj/answer/getPrevQuestion.do',
			type: 'post',
			dataType:'json',
			data: {
				answerSeq: answerSeq||"",
				questionId: questionId||"", 
				investigationId: investigationId||"",
			},
			success: function(data){
				if(data.infoMsg == "9999"){
					$.popAlert("查询上一题失败");
				}else{
					var question=data.detail;
					var answer=data.answerList;
					if(data.questMark == "0"){
						window.location.href="../../h5/answer/comment.html";
					}else if(data.detail.questionSeq == "1"){//显示第一题
						showBefore();
					}
					var options = '';
					questionType = question.questionType;
					if(questionType == 'mmc' || questionType == 'mmcs'){//矩阵分支
						options = '<li><label>'+getOptionHtml(question.questionType,data,answer)+'</label></li>';
					}else{//非矩阵分支
						question.options.forEach(function(option){//选项
							options += '<li><label>'+getOptionHtml(question.questionType,option,answer)+ (showName(question.questionType)?'':option.optName) +'</label></li>';
						});
					}
					html = '<div class="QAContent" data-answer-type ="'+question.questionType+'" data-answer-seq ="'+question.questionSeq+'" data-qsr-id ="'+data.detail.qsrId+'" data-qst-id="'+question.qstId+'">' + 
					'<h1>'+ question.questionSeq +'.'+ question.questionName +'</h1>' +
					'<ul>'+ options +'</ul>' +
					'</div>'
					$('.QAContents').html(html);
					if(questionType == 'scr' && answer){//评分选星
						answer.forEach(function(option){
							var id = option.optionId;
							starChose(id,option.scoreValue);
						})
					}
				}
			
			}
		});
	});
}

//获取下一道题
function goNext(){
	/**
	 * 先要判断题目的类型
	 * 然后根据不同的题目类型获取相对应的问题ID
	 * 获取相对应的选项ID
	 */
	$('.QAContent').each(function(index,item){
		var investigationId = $(item).data("qsrId");//问卷ID
		var questionId= $(item).data("qstId");//问题ID
		var qtype = $(item).data("answerType");//问卷类型
		var answerSeq = $(item).data("answerSeq");//题号
		var optionId;
		var qaqValue;
		var optionColumnId;
		var mutilateOption = [];
		switch (qtype){
			case 'mc'://单选
				var mcFlag = false;
				$(this).find('input:checked').each(function(){
					optionId = this.id;
					flag = true;
					mcFlag = true;
				});
				if(!mcFlag){
					flag = false;
				}
				checkFlag(flag);
				break;
			case 'mcs'://多选题
				var mcsFlag = false;
				var array=[];
				var mcsVal = [];
				var i = 0;
				$(this).find('input').each(function(){
					if(this.checked){
						flag = true;
						mcsFlag = true;
						optionId = this.id;//选项ID
						mcsVal.push(this.value);
						mutilateOption.push({'optionId': optionId});
						i = i+1;
					}
				});
				if(!mcsFlag){
					flag = false;
				}
				checkFlag(flag);
				break;
			case 'scr'://评分题
				mutilateOption = [];
				var fieldsetlength=$(this).find('fieldset').length;
				var checkcount=0;
				$(this).find('fieldset').each(function(){
					//获取评分的选项ID
					var scrValue = $(this).find('input').val();
					var scrOptionId=$(this).find('input').attr('id');
					if(Validator.validateNull(scrValue)){
						flag = false;
					}else{
						flag = true;
						checkcount  = checkcount + 1;
						mutilateOption.push({'optionId': scrOptionId,'scoreValue': scrValue});
					}
				});
				if(fieldsetlength!=checkcount){
					flag = false;
				}
				checkFlag(flag);
				break;
			case 'qaq'://问答题
				var checkQaqCount=0;
				var qaqLength= $(this).find('textarea').length;
				$(this).find('textarea').each(function(){
					//获取评分的选项ID
					var qVal = $(this).val();
					if(Validator.validateNull(qVal)){
						flag = false;
					}else{
						flag = true;
						checkQaqCount  = checkQaqCount + 1;
						qaqValue = qVal;
					}
				});
				if(qaqLength!=checkQaqCount){
					flag = false;
				}
				checkFlag(flag);
				break;
			case 'pmc'://图片单选   
				var pmcFlag = false;
				$(this).find('input:checked').each(function(){
					optionId = this.id;
					flag = true;
					pmcFlag = true;
				});
				if(!pmcFlag){
					flag =  false;
				}
				checkFlag(flag);
				break;
				break;
			case 'pmcs'://图片多选
				var pmcsFlag = false;
				var array=[];
				var mcsVal = [];
				var i = 0;
				$(this).find('input').each(function(){
					if(this.checked){
						flag = true;
						pmcsFlag = true;
						optionId = this.id;//选项ID
						mcsVal.push(this.value);
						mutilateOption.push({'optionId': optionId});
						i = i+1;
					}
				});
				if(!pmcsFlag){
					flag = false;
				}
				checkFlag(flag);
				break;
			case 'mmc'://矩阵单选
				var comPareFlag = $(this).find('input')[0].name;
				var comPare = [];
				comPare.push(comPareFlag);
				var checked = [];
				$(this).find('input').each(function(){
					if(comPareFlag != this.name && comPare.indexOf(this.name) < 0){
						comPare.push(this.name);
					}
					if(this.checked){
						if(checked.indexOf(this.name) < 0){
							checked.push(this.name);
						}
						flag = true;
						optionId = this.name;//y轴ID
						optionColumnId = this.id;//x轴ID
						mutilateOption.push({'optionId': optionId,'optionColumnId': optionColumnId});
					}
				});
				if(comPare.length != checked.length){
					flag = false;
				}
				checkFlag(flag);
				break;
			case 'mmcs'://矩阵多选
				var comPareFlag = $(this).find('input')[0].name;
				var comPare = [];
				comPare.push(comPareFlag);
				var checked = [];
				$(this).find('input').each(function(){
					if(comPareFlag != this.name && comPare.indexOf(this.name) < 0){
						comPare.push(this.name);
					}
					if(this.checked){
						if(checked.indexOf(this.name) < 0){
							checked.push(this.name);
						}
						flag = true;
						optionId = this.name;//y轴ID
						optionColumnId = this.id;//x轴ID
						mutilateOption.push({'optionId': optionId,'optionColumnId': optionColumnId});
					}
				});
				if(comPare.length != checked.length){
					flag = false;
				}
				checkFlag(flag);
				break;
			default:
				break;
		}
		//弹出框
		function checkFlag(flag){
			if(!flag){
				$.popAlert("请先完成本题");
			}else{
				//请求下一题
				mutilateOption = JSON.stringify(mutilateOption);
				$.ajax({
					url: '/pawj/answer/answerOne.do',
					type: 'post',
					dataType:'json',
					data: {
						answerSeq: answerSeq || "",
						questMark: questMark || "",
						questionId: questionId || "", 
						qtype: qtype || "",
						investigationId: investigationId || "",
						optionId: optionId || "",
						optionColumnId: optionColumnId || "",
						qaqValue: qaqValue || "",
						mutilateOption: mutilateOption || ""
					},
					success: function(data){
						if(data.infoMsg == "9999"){
							alert("错误");
						}else{
							var question=data.detail;
							if(data.questMark == "0"){
								window.location.href="../../h5/answer/comment.html";
								return;
							}else{
								showNext();
								notShowNum();
							}
							var options = '';
							questionType = question.questionType;
							if(questionType == 'mmc' || questionType == 'mmcs'){//矩阵分支
								options = '<li><label>'+getOptionHtml(question.questionType,data)+'</label></li>';
							}else{//非矩阵分支
								question.options.forEach(function(option){//选项
									options += '<li><label>'+getOptionHtml(question.questionType,option)+ (showName(question.questionType)?'':option.optName) +'</label></li>';
								});
							}
							html = '<div class="QAContent" data-answer-type ="'+question.questionType+'" data-answer-seq ="'+question.questionSeq+'" data-qsr-id ="'+data.detail.qsrId+'" data-qst-id="'+question.qstId+'">' + 
							'<h1>'+ question.questionSeq +'.'+ question.questionName +'</h1>' +
							'<ul>'+ options +'</ul>' +
							'</div>'
							$('.QAContents').html(html);
						}
					}
				});
			}
		}
	});
}