/**
 * 给时间框控件扩展一个清除的按钮
 */
$.fn.datebox.defaults.cleanText = '清空';

(function($) {
	var buttons = $.extend([], $.fn.datebox.defaults.buttons);
	buttons.splice(1, 0, {
		text : function(target) {
			return $(target).datebox("options").cleanText
		},
		handler : function(target) {
			$(target).datebox("setValue", "");
			$(target).datebox("hidePanel");
		}
	});
	$.extend($.fn.datebox.defaults, {
		buttons : buttons
	});

})(jQuery)

/**
 * 给时间框控件扩展一个清除的按钮
 */
$.fn.datetimebox.defaults.cleanText = '清空';

(function($) {
	var buttons = $.extend([], $.fn.datetimebox.defaults.buttons);
	buttons.splice(1, 0, {
		text : function(target) {
			return $(target).datetimebox("options").cleanText
		},
		handler : function(target) {
			$(target).datetimebox("setValue", "");
			$(target).datetimebox("hidePanel");
		}
	});
	$.extend($.fn.datetimebox.defaults, {
		buttons : buttons
	});

})(jQuery)

$(function() {
	// 加载表格数据
	ajaxTable();

	// 初始化弹出层
	setDialog_add();
	closeDialog_add();
	setDialog_edit();
	closeDialog_edit();
});

/** --------------table------------------* */
/**
 * 加载表格数据
 */
function ajaxTable() {
	$("#startTime").datebox("setValue", getSearchDate(true));
	$("#endTime").datebox("setValue", getSearchDate(false));
	// 加载表格
	$('#loginInfoTable')
			.datagrid(
					{
						toolbar : '#easyui_toolbar',
						pageNumber : 1,
						loadMsg : '数据加载中,请稍后...',
						pageSize : 20,
						pageList : [ 20, 30, 50 ], // 设置每页显示多少条
						onLoadError : function() {
							top.location.href="/pawj/wjadd/login.html"
						},
						queryParams : {// 查询条件
						},

						onClickRow : function(rowIndex, rowData) { // 取消选择某行后高亮

							$('#loginInfoTable').datagrid('unselectRow',
									rowIndex);
						},

						onLoadSuccess : function(data) {
							$(".datebox :text").attr("readonly", "readonly");
							$(".textbox-text")
							var value = $('#loginInfoTable')
									.datagrid('getData')['errorMsg'];
							if (value != null) {
								alert("错误消息:" + value);
							}
							if (data.total == 0) {
								var body = $(this).data().datagrid.dc.body2;
								body
										.find('table tbody')
										.append(
												'<tr><td " + " style=" text-align: center;border:none;font-size:20px" colspan="8">暂无数据!</td></tr>');
							}
						},
						onSelectAll : function(rows) {
							$('#loginInfoTable').datagrid('clearSelections');
						},
						onUnselectAll : function(rows) {
						},
						onCheck : function(rowIndex, rowData) {
							$('#loginInfoTable').datagrid('unselectRow',
									rowIndex);
						},
						onUncheck : function(rowIndex, rowData) {
						}
					}).datagrid('acceptChanges');

	setTimeout("doSearch()", 300);
}

function getSearchDate(ifStart) {
	var d = new Date();
	if (ifStart) {
		d.setMonth(d.getMonth() - 1);
	}
	var year = d.getFullYear();
	var month = d.getMonth() + 1;
	month = month < 10 ? ('0' + month) : month;
	var day = d.getDate();
	day = day < 10 ? ('0' + day) : day;
	return year + '-' + month + '-' + day;
}

/**
 * 设置操作列的信息 参数说明 value 这个可以不管，但是要使用后面 row 和index 这个参数是必须的 row 当前行的数据 index
 * 当前行的索引 从0 开始
 */
function optFormater(value, row, index) {
	var loginId = row.loginId;
	var loginCode = row.loginCode;
	var id_code = loginId + ",'" + loginCode + "'";
	var opt = '';
	if (row.statuId == 0) {
		opt = '<a href="#" onclick="doUsable(' + row.loginId + ')">启用</a> | ';
	} else if (row.statuId == 1) {
		opt = '<a href="#" onclick="doForbidden(' + row.loginId
				+ ')">禁用</a> |  ';
	}
	var detail = '<a href="#" onclick="goDetail(' + row.loginId
			+ ')">详细</a> |  ';
	var edit = '<a href="javascript:openDialog_edit(' + index + ')">编辑</a> | ';
	var del = '<a href="#" onclick="doDel(\'' + row.investigationId
			+ '\')">删除</a>';
	var question = '<a href="#" onclick="showQuestionList(\''
			+ row.investigationId + '\')">编辑</a> |  ';
	if(row.status==3){
		question='<a href="#" onclick="showQuestionList(\''
			+ row.investigationId + '&view=false'+'\')">编辑</a> |  ';
	}
	return question + del;
};

function withTitle(value) {
	if (!value) {
		return '';
	}
	return "<span title='" + value + "'>" + value + "</span>";
}
// 刷新表格
function reloadTable() {
	$('#loginInfoTable').datagrid('reload');
}

/** --------------添加操作弹出框------------------* */
// 设置弹出框的属性
function setDialog_add() {
	$('#loginInfoAdd').dialog({
		title : '问卷添加',
		modal : true, // 模式窗口：窗口背景不可操作
		collapsible : false, // 可折叠，点击窗口右上角折叠图标将内容折叠起来
		resizable : false, // 可拖动边框大小
		onClose : function() { // 继承自panel的关闭事件
			loginInfoAddReset();
		}
	});
}
// 打开对话框
function openDialog_add() {
	showQuestionList("",true);
	return;
	$('input.easyui-validatebox').validatebox('disableValidation')// ////////
	.focus(function() {
		$(this).validatebox('enableValidation');
	}).blur(function() {
		$(this).validatebox('validate')
	});
	$('#loginInfoAdd').dialog('open');
	$('#loginInfoAdd').dialog({
		title : '添加问卷'
	});
	$('#wj_status').combobox({
		url : '/pawj/common/queryDic.do?dicCode=qsrStatus',
		valueField : 'dicValue',
		textField : 'dicDesc',
		width : '85px',
		panelHeight : 'auto',
		editable : false,
		onChange : function(record) {
			// console.log(record);
		},
		onLoadSuccess : function() {
			$('#wj_status').combobox("setValue", 1);
		}
	});
	$("#questionInfoId").val('');
}
// 关闭对话框
function closeDialog_add() {
	$('#loginInfoAdd').dialog('close');
}
// 执行用户添加操作
function loginInfoAdd() {
	var isValid = true;

	$('#table_loginInfoAdd input').each(function() {
		if ($(this).attr('required') || $(this).attr('validType')) {
			$(this).validatebox('enableValidation');
			if (!$(this).validatebox('isValid')) {
				// 如果验证不通过，则返回false
				isValid = false;
				return;
			}
		}
	});
	if (!isValid) {
		$.messager.alert('警告', "请输入必输字段！", 'warning');
		return;
	}

	$.ajax({
		async : false,
		cache : false,
		type : 'POST',
		dataType : "json",
		data : {
			"investigationId" : $("#questionInfoId").val(),
			"name" : $("#wjinfo_name").val(),
			"userId" : $("#wjinfo_auth").val(),
			"brief" : $("#wjinfo_desc").val(),
			"planCopy" : $("#wjinfo_copies").val(),
			"answerFee" : $("#wjinfo_answer_fee").val(),
			"coefficient" : $("#wjinfo_xishu").val(),
			"planStartTime" : $("#startTimePlan").datetimebox("getValue"),
			"planEndTime" : $("#endTimePlan").datetimebox("getValue"),
			"status" : $("#wj_status").combobox('getValue')
		},
		url : '/pawj/investigation/saveInvestigation.do',// 请求的action路径
		error : function() {// 请求失败处理函数
			alert('请求失败');
		},
		success : function(data) {
			var messgage = "添加成功!";
			if (data == null) {// 未返回任何消息表示添加成功
				loginInfoAddReset();
				// 刷新列表
			} else if (data.errorMsg != null) {// 返回异常信息
				messgage = data.errorMsg;
			}
			$("#questionInfoId").val("")
			reloadTable();
			$("#loginInfoAdd_message").html(messgage);
			closeDialog_add();
		}
	});
}
// 用户添加页面数据重置操作
function loginInfoAddReset() {
	$('input.easyui-validatebox').validatebox('disableValidation')// ////////
	.focus(function() {
		$(this).validatebox('enableValidation');
	}).blur(function() {
		$(this).validatebox('validate')
	});
	$("#loginInfoAdd_message").html("");
	$("#wjinfo_name").val("");
	$("#wjinfo_desc").val("");
	$("#wjinfo_auth").val("");
	$("#wjinfo_copies").val("");
	$("#wjinfo_answer_fee").val("");
	$("#wjinfo_xishu").val("");
	$("#startTimePlan").datetimebox('setValue', '');
	$("#endTimePlan").datetimebox('setValue', '');

}

/** --------------编辑操作弹出框------------------* */
// 设置弹出框的属性
function setDialog_edit() {
	$('#loginInfoEdit').dialog({
		title : '用户编辑',
		modal : true, // 模式窗口：窗口背景不可操作
		collapsible : true, // 可折叠，点击窗口右上角折叠图标将内容折叠起来
		resizable : true
	// 可拖动边框大小
	});
}
// 打开对话框
function openDialog_edit(index) {
	$('#loginInfoAdd').dialog('open');
	$('#loginInfoAdd').dialog({
		title : '编辑问卷'
	});

	var row = $('#loginInfoTable').datagrid('getData').rows[index];
	$("#questionInfoId").val(row.investigationId);
	$("#wjinfo_name").val(row.name);
	$("#wjinfo_auth").val(row.userId);
	$("#wjinfo_desc").val(row.brief);
	$("#wjinfo_copies").val(row.planCopy);
	$("#wjinfo_answer_fee").val(row.answerFee);
	$("#wjinfo_xishu").val(row.coefficient);
	$("#startTimePlan").datetimebox('setValue', row.planStartTime);
	$("#endTimePlan").datetimebox('setValue', row.planEndTime);
	$('input.easyui-validatebox').validatebox('disableValidation')// ////////
	.focus(function() {
		$(this).validatebox('enableValidation');
	}).blur(function() {
		$(this).validatebox('validate')
	});

	$('#wj_status').combobox({
		url : '/pawj/common/queryDic.do?dicCode=qsrStatus',
		valueField : 'dicValue',
		textField : 'dicDesc',
		width : '85px',
		panelHeight : 'auto',
		editable : false,
		onChange : function(record) {
			// console.log(record);
		},
		onLoadSuccess : function() {
			$('#wj_status').combobox("setValue", parseInt(row.status));
		}
	});
}
// 关闭对话框
function closeDialog_edit() {
	$('#loginInfoEdit').dialog('close');
}
// 根据用户id查询用户的信息
function loginInfoEditReset(loginId, loginCode) {
	$("#loginInfoEdit_message").html("");
	$("#loginInfoEdit_loginId").val(loginId);
	$("#loginInfoEdit_loginCode").html(loginCode);
	$("#loginInfoEdit_password").val("");
	$("#loginInfoEdit_repassword").val("");
}
// 执行用户编辑操作
function loginInfoEdit() {
	var validateResult = true;
	// easyui 表单验证
	$('#table_loginInfoEdit input').each(function() {
		if ($(this).attr('required') || $(this).attr('validType')) {
			if (!$(this).validatebox('isValid')) {
				// 如果验证不通过，则返回false
				validateResult = false;
				return;
			}
		}
	});
	if (validateResult == false) {
		return;
	}

	$
			.ajax({
				async : false,
				cache : false,
				type : 'POST',
				dataType : "json",
				data : {
					"loginInfoEditDto.loginInfo.id" : $(
							"#loginInfoEdit_loginId").val(),
					"loginInfoEditDto.loginInfo.password" : $(
							"#loginInfoEdit_password").val(),
					"loginInfoEditDto.rePassword" : $(
							"#loginInfoEdit_repassword").val()
				},
				url : root + '/ospm/loginInfo/doLoginInfoEdit.jhtml',// 请求的action路径
				error : function() {// 请求失败处理函数
					alert('请求失败');
				},
				success : function(data) {
					var messgage = "修改成功!";
					if (data == null) {// 未返回任何消息表示添加成功
						// 刷新列表
						reloadTable();
					} else if (data.errorMsg != null) {// 返回异常信息
						messgage = data.errorMsg;
					}
					$("#loginInfoEdit_message").html(messgage);
				}
			});
}

/** --------------执行删除操作------------------* */
function doDel(qsrId) {
	$.messager.confirm('删除提示', '你确定永久删除该数据吗?', function(r) {
		if (r) {
			var url = '/pawj/investigation/delInvestigation.do' + '?idListStr='
					+ qsrId;
			changeStatus(url);
		}
	});
}
/**
 * 启用
 * 
 * @param loginId
 * @return
 */
function doUsable(loginId) {
	$.messager.confirm('启用提示', '你确定启用该数据吗?', function(r) {
		if (r) {
			var url = root
					+ '/ospm/loginInfo/doLoginInfoAvailable.jhtml?loginId='
					+ loginId;
			changeStatus(url);
		}
	});
}
/**
 * 禁用
 * 
 * @param loginId
 * @return
 */
function doForbidden(loginId) {
	$.messager.confirm('删除提示', '你确定禁用该数据吗?', function(r) {
		if (r) {
			var url = root
					+ '/ospm/loginInfo/doLoginInfoInvalid.jhtml?loginId='
					+ loginId;
			changeStatus(url);
		}
	});
}

/**
 * 修改状态的Ajax
 * 
 * @param url
 * @return
 */
function changeStatus(url) {
	$.ajax({
		async : false,
		cache : false,
		type : 'POST',
		dataType : "json",
		url : url,// 请求的action路径
		error : function() {// 请求失败处理函数
			alert('请求失败');
		},
		success : function(data) {
			if (data != null && data.errorMsg != null) {// 返回异常信息
				$.messager.alert('错误提示', data.errorMsg, 'error');
			}
			$('#loginInfoTable').datagrid('clearChecked');
			reloadTable();
		}
	});
}

function editQuestionList(qsrId) {

	$.ajax({
		async : false,
		cache : false,
		type : 'POST',
		dataType : "json",
		data : {
			"investigationId" : qsrId,
			"name" : $("#wjinfo_name").val(),
			"userId" : $("#wjinfo_auth").val(),
			"brief" : $("#wjinfo_desc").val(),
			"planCopy" : $("#wjinfo_copies").val(),
			"answerFee" : $("#wjinfo_answer_fee").val(),
			"coefficient" : $("#wjinfo_xishu").val(),
			"planStartTime" : $("#startTimePlan").datetimebox("getValue"),
			"planEndTime" : $("#endTimePlan").datetimebox("getValue"),
			"status" : $("#wj_status").combobox('getValue')
		},
		url : '/pawj/investigation/saveInvestigation.do',// 请求的action路径
		error : function() {// 请求失败处理函数
			alert('请求失败');
		},
		success : function(data) {
			var messgage = "添加成功!";
			if (data == null) {// 未返回任何消息表示添加成功
				loginInfoAddReset();
				// 刷新列表
			} else if (data.errorMsg != null) {// 返回异常信息
				messgage = data.errorMsg;
			}
			$("#questionInfoId").val(data.investigationId)
			reloadTable();
			showQuestionList(qsrId);
		}
	});

}

function showQuestionList(qsrId,isAdd) {
	var titleText = "问卷编辑";
	if(isAdd){
		titleText = "问卷新增";
	}
	$("#questionList")
			.window(
					{
						title : titleText,
						width : 800,
						height : 600,
						modal : true,
						content : '<iframe id="questionIframe" "src="'
								+ "/pawj/wjadd/myQuestionWindow.jsp?qsrId="
								+ qsrId
								+ '" width="100%" height="100%" frameborder="0" scrolling="auto" ></iframe>',
						cache : false,
						collapsible : false,
						minimizable : false
					});
	$("#questionIframe").attr("src",
			"/pawj/wjadd/invInfos.jsp?qsrId=" + qsrId);
}

function closeWindow() {
	$("#questionList").window('close');
	reloadTable();
}

function entersearch(event){
    if (event.keyCode == 13)
    {
        doSearch();
    }
}

function doSearch() {
	$('#loginInfoTable').datagrid({
		'url' : '/pawj/investigation/queryInvestigation.do',
		'height' : '100%',
		queryParams : setParamJson()
	});
}

function resetForm() {
	$("#qsrName").val('');
	$("#qsrDesc").val('');
	$("#publisher").val('');
}

function setParamJson() {
	var paramObj = {};
	var qsrName = $("#qsrName").val();
	var qsrDesc = $("#qsrDesc").val();
	var publisher = $("#publisher").val();

	if (isValueNotEmpty(qsrName)) {
		paramObj.name = trim(qsrName);
	}
	if (isValueNotEmpty(qsrDesc)) {
		paramObj.brief = trim(qsrDesc);
	}
	if (isValueNotEmpty(publisher)) {
		paramObj.userId = trim(publisher);
	}
	return paramObj
}

function isValueNotEmpty(val) {
	return val && trim(val) != '';
}

function trim(val) {
	return (val + '').replace(/(^\s*)|(\s*$)/g, "");
}

/**
 * 批量操作
 * 
 * @return
 */
function batch(flag) {
	if ($('#loginInfoTable').datagrid('getChecked')&&$('#loginInfoTable').datagrid('getChecked').length>0) {
		// 首先如果用户选择了数据，则获取选择的数据集合
		var ids = [];
		var cods = [];

		var selectedRow = $('#loginInfoTable').datagrid('getChecked');
		for (var i = 0; i < selectedRow.length; i++) {
			ids.push(selectedRow[i].investigationId);
		}
		var qsrIds = ids.join(',');

		if (flag == "available") {
			// 启用操作
			$.messager
					.confirm(
							'启用提示',
							'你确定启用下列用户吗?<br/>' + cods.join(','),
							function(r) {
								if (r) {
									var url = root
											+ '/ospm/loginInfo/doLoginInfoAvailable.jhtml?loginId='
											+ loginId;
									changeStatus(url);
								}
							});
		} else if (flag == "invalid") {
			// 禁用操作
			$.messager
					.confirm(
							'禁用提示',
							'你确定禁用下列用户吗?<br/>' + cods.join(','),
							function(r) {
								if (r) {
									var url = root
											+ '/ospm/loginInfo/doLoginInfoInvalid.jhtml?loginId='
											+ loginId;
									changeStatus(url);
								}
							});
		} else {
			// 删除操作
			$.messager.confirm('删除提示', '你确定永久删除这' + ids.length + '条问卷吗?<br/>',
					function(r) {
						if (r) {
							var url = '/pawj/investigation/delInvestigation.do'
									+ '?idListStr=' + ids.join(',');
							changeStatus(url);
						}
					});
		}
	} else {
		$.messager.alert('提示', "请先选择记录！", 'info');
	}// end of if
}
